(window.webpackJsonp=window.webpackJsonp||[]).push([[115],{296:function(s,e,n){"use strict";n.r(e);var a=n(14),t=Object(a.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("前几篇文章中，我们介绍了webpack v4.20.2相关的内容，"),e("br"),s._v("\n但是很多老项目，还在使用webpack 3，"),e("br"),s._v("\n也要一些常用的代码库在webpack 4中是不兼容的。")]),s._v(" "),e("p",[s._v("例如，"),e("strong",[s._v("extract-text-webpack-plugin")]),s._v("，目前仍不兼容webpack 4，"),e("br"),s._v("\n可以参考github中这个issue，"),e("a",{attrs:{href:"https://github.com/webpack-contrib/extract-text-webpack-plugin/issues/701",target:"_blank",rel:"noopener noreferrer"}},[s._v("Webpack 4 compatibility"),e("OutboundLink")],1),s._v("。")]),s._v(" "),e("p",[s._v("而且，我在学习webpack源码的过程中，"),e("br"),s._v("\nextract-text-webpack-plugin这个插件，确实给我造成了不小的"),e("strong",[s._v("困扰")]),s._v("，"),e("br"),s._v("\n它用到了childCompiler这个概念，很值得一看。")]),s._v(" "),e("p",[s._v("本文我们自成体系，来看看webpack 3项目，以及extract-text-webpack-plugin的实现逻辑。"),e("br"),s._v("\n一图胜千言，")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-5ea9bd96ee2b6daf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511/format/webp",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"_1-webpack-3示例应用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-webpack-3示例应用"}},[s._v("#")]),s._v(" 1. webpack 3示例应用")]),s._v(" "),e("h4",{attrs:{id:"_1-1-初始化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-初始化"}},[s._v("#")]),s._v(" 1.1 初始化")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$ mkdir ~/Test/debug-webpack3\n$ cd ~/Test/debug-webpack3\n$ npm init -f\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h4",{attrs:{id:"_1-2-安装依赖"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-安装依赖"}},[s._v("#")]),s._v(" 1.2 安装依赖")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$ npm i -D \\\nwebpack@3.11.0 \\\nbabel-loader@7.1.3 \\\nbabel-core@6.26.0 \\\nbabel-preset-env@1.6.1 \\\nextract-text-webpack-plugin@3.0.2 \\\ncss-loader@0.28.10 \\\nless-loader@4.0.6 \\\nless@2.7.3\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h4",{attrs:{id:"_1-3-配置webpack"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-配置webpack"}},[s._v("#")]),s._v(" 1.3 配置webpack")]),s._v(" "),e("p",[s._v("新建webpack.config.js，")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("const path = require('path');\nconst ExtractTextPlugin = require('extract-text-webpack-plugin');\n\nmodule.exports = {\n    entry: {\n        index: path.resolve(__dirname, 'src/index.js'),\n    },\n    output: {\n        path: path.resolve(__dirname, 'dist/'),\n        filename: '[name].js',\n    },\n    module: {\n        rules: [\n            { test: /.js$/, use: { loader: 'babel-loader', query: { presets: ['babel-preset-env'] } } },\n            {\n                test: /.less$/,\n                use: ExtractTextPlugin.extract({\n                    use: [\n                        { loader: 'css-loader' },\n                        { loader: 'less-loader' },\n                    ],\n                }),\n            },\n        ]\n    },\n    plugins: [\n        new ExtractTextPlugin({\n            filename: '[name].css',\n        }),\n    ]\n};\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("p",[s._v("以上代码中，我们使用了extract-text-webpack-plugin，"),e("br"),s._v("\n（1）对于 .less 文件，使用"),e("code",[s._v("ExtractTextPlugin.extract")]),s._v("配置loader"),e("br"),s._v("\n（2）在"),e("code",[s._v("plugins")]),s._v("中，增加了一个"),e("code",[s._v("ExtractTextPlugin")]),s._v("的实例")]),s._v(" "),e("p",[e("strong",[s._v("注：")]),e("br"),s._v("\n虽然我们已经为"),e("code",[s._v("ExtractTextPlugin")]),s._v("实例配置了"),e("code",[s._v("filename")]),s._v("，"),e("br"),s._v("\n但是extract-text-webpack-plugin仍然需要webpack.config.js导出"),e("code",[s._v("output.filename")]),s._v("，"),e("br"),s._v("\n所以，我们在第"),e("code",[s._v("10")]),s._v("行"),e("code",[s._v("output")]),s._v("属性中增加了"),e("code",[s._v("filename")]),s._v("字段。")]),s._v(" "),e("h4",{attrs:{id:"_1-4-添加npm-scripts"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-添加npm-scripts"}},[s._v("#")]),s._v(" 1.4 添加npm scripts")]),s._v(" "),e("p",[s._v("打开package.json，为"),e("code",[s._v("scripts")]),s._v("属性添加一个"),e("code",[s._v("build")]),s._v("字段，值为"),e("code",[s._v('"webpack"')])]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n  ...\n  "scripts": {\n    ...\n    "build": "webpack"\n  },\n  ...\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h4",{attrs:{id:"_1-5-新建源码文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-新建源码文件"}},[s._v("#")]),s._v(" 1.5 新建源码文件")]),s._v(" "),e("p",[e("strong",[s._v("（1）src/index.js")])]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("import './index.less';\n\nalert();\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[e("strong",[s._v("（2）src/index.less")])]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("body {\n    background: gray;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h4",{attrs:{id:"_1-6-编译打包"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-编译打包"}},[s._v("#")]),s._v(" 1.6 编译打包")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$ npm run build\n\n> debug-webpack3@1.0.0 build ~/Test/debug-webpack3\n> webpack\n\nHash: 1b8999f3bb679ecffd56\nVersion: webpack 3.11.0\nTime: 673ms\n    Asset      Size  Chunks             Chunk Names\n index.js   2.64 kB       0  [emitted]  index\nindex.css  29 bytes       0  [emitted]  index\n   [0] ./src/index.js 49 bytes {0} [built]\n   [1] ./src/index.less 41 bytes {0} [built]\n    + 1 hidden module\nChild extract-text-webpack-plugin node_modules/_extract-text-webpack-plugin@3.0.2@extract-text-webpack-plugin/dist node_modules/_css-loader@0.28.10@css-loader/index.js!node_modules/_less-loader@4.0.6@less-loader/dist/cjs.js!src/index.less:\n       [0] ./node_modules/_css-loader@0.28.10@css-loader!./node_modules/_less-loader@4.0.6@less-loader/dist/cjs.js!./src/index.less 211 bytes {0} [built]\n        + 1 hidden module\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h4",{attrs:{id:"_1-7-查看编译结果"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-查看编译结果"}},[s._v("#")]),s._v(" 1.7 查看编译结果")]),s._v(" "),e("p",[e("strong",[s._v("（1）dist/index.js")])]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("/******/ (function(modules) { // webpackBootstrap\n/******/    // The module cache\n/******/    var installedModules = {};\n/******/\n/******/    // The require function\n/******/    function __webpack_require__(moduleId) {\n/******/\n/******/        // Check if module is in cache\n/******/        if(installedModules[moduleId]) {\n/******/            return installedModules[moduleId].exports;\n/******/        }\n/******/        // Create a new module (and put it into the cache)\n/******/        var module = installedModules[moduleId] = {\n/******/            i: moduleId,\n/******/            l: false,\n/******/            exports: {}\n/******/        };\n/******/\n/******/        // Execute the module function\n/******/        modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n/******/\n/******/        // Flag the module as loaded\n/******/        module.l = true;\n/******/\n/******/        // Return the exports of the module\n/******/        return module.exports;\n/******/    }\n/******/\n/******/\n/******/    // expose the modules object (__webpack_modules__)\n/******/    __webpack_require__.m = modules;\n/******/\n/******/    // expose the module cache\n/******/    __webpack_require__.c = installedModules;\n/******/\n/******/    // define getter function for harmony exports\n/******/    __webpack_require__.d = function(exports, name, getter) {\n/******/        if(!__webpack_require__.o(exports, name)) {\n/******/            Object.defineProperty(exports, name, {\n/******/                configurable: false,\n/******/                enumerable: true,\n/******/                get: getter\n/******/            });\n/******/        }\n/******/    };\n/******/\n/******/    // getDefaultExport function for compatibility with non-harmony modules\n/******/    __webpack_require__.n = function(module) {\n/******/        var getter = module && module.__esModule ?\n/******/            function getDefault() { return module['default']; } :\n/******/            function getModuleExports() { return module; };\n/******/        __webpack_require__.d(getter, 'a', getter);\n/******/        return getter;\n/******/    };\n/******/\n/******/    // Object.prototype.hasOwnProperty.call\n/******/    __webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n/******/\n/******/    // __webpack_public_path__\n/******/    __webpack_require__.p = \"\";\n/******/\n/******/    // Load entry module and return exports\n/******/    return __webpack_require__(__webpack_require__.s = 0);\n/******/ })\n/************************************************************************/\n/******/ ([\n/* 0 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\n\n__webpack_require__(1);\n\nalert();\n\n/***/ }),\n/* 1 */\n/***/ (function(module, exports) {\n\n// removed by extract-text-webpack-plugin\n\n/***/ })\n/******/ ]);\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br"),e("span",{staticClass:"line-number"},[s._v("79")]),e("br"),e("span",{staticClass:"line-number"},[s._v("80")]),e("br"),e("span",{staticClass:"line-number"},[s._v("81")]),e("br"),e("span",{staticClass:"line-number"},[s._v("82")]),e("br"),e("span",{staticClass:"line-number"},[s._v("83")]),e("br"),e("span",{staticClass:"line-number"},[s._v("84")]),e("br")])]),e("p",[e("strong",[s._v("（2）dist/index.css")])]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("body {\n  background: gray;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"_2-调试webpack3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-调试webpack3"}},[s._v("#")]),s._v(" 2. 调试webpack3")]),s._v(" "),e("h4",{attrs:{id:"_2-1-新建debug-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-新建debug-js"}},[s._v("#")]),s._v(" 2.1 新建debug.js")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("const webpack = require('webpack');\nconst options = require('./config/webpack.config');\n\nconst compiler = webpack(options);\n\ncompiler.run((...args) => {\n    console.log(...args);\n});\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h4",{attrs:{id:"_2-2-使用vscode进行调试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-使用vscode进行调试"}},[s._v("#")]),s._v(" 2.2 使用vscode进行调试")]),s._v(" "),e("p",[s._v("在以上代码第"),e("code",[s._v("6")]),s._v("行中，打个断点，保持光标位于该文件中，按"),e("code",[s._v("F5")]),s._v("。"),e("br"),s._v("\n然后程序停在了断点处，")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-43c9ada51194dc31.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/473/format/webp",alt:""}})]),s._v(" "),e("h4",{attrs:{id:"_2-3-轻车熟路"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-轻车熟路"}},[s._v("#")]),s._v(" 2.3 轻车熟路")]),s._v(" "),e("p",[s._v("前几篇中，我们已经对webpack v4.20.2有了一定的了解，"),e("br"),s._v("\n现在虽然是webpack3（v.3.11.0），我们还是能够驾轻就熟。")]),s._v(" "),e("p",[e("code",[s._v("compiler.run")]),s._v("，会跳入"),e("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v3.11.0/lib/Compiler.js#L226",target:"_blank",rel:"noopener noreferrer"}},[s._v("Compiler.js 第226行"),e("OutboundLink")],1),s._v("的"),e("code",[s._v("run")]),s._v("方法中，")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('run(callback) {\n    ...\n    this.applyPluginsAsync("before-run", this, err => {\n        ...\n        this.applyPluginsAsync("run", this, err => {\n            ...\n            this.readRecords(err => {\n                ...\n                this.compile(onCompiled);\n            });\n        });\n    });\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("与之前的v4.20.2对比一下， "),e("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compiler.js#L198",target:"_blank",rel:"noopener noreferrer"}},[s._v("webpack 4.20.2 Compiler.js 第198行"),e("OutboundLink")],1),s._v("，")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("run(callback) {\n    ...\n    this.hooks.beforeRun.callAsync(this, err => {\n        ...\n        this.hooks.run.callAsync(this, err => {\n            ...\n            this.readRecords(err => {\n                ...\n                this.compile(onCompiled);\n            });\n        });\n    });\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("我们发现，webpack3中的"),e("code",[s._v('this.applyPluginsAsync("before-run", this, err => {')]),s._v("，"),e("br"),s._v("\n刚好对应与webpack4中的"),e("code",[s._v("this.hooks.beforeRun.callAsync(this, err => {")]),s._v(" 。"),e("br"),s._v("\n其余几个hooks调用也类似。")]),s._v(" "),e("p",[s._v("下文中，我们仍然称插件中实现的切面为hooks。"),e("br"),s._v("\n所以，我们还是可以按以前的分析，知道"),e("code",[s._v("compiler.run")]),s._v("调用了"),e("code",[s._v("this.compile")]),s._v("，"),e("br"),s._v("\n于是我们在"),e("code",[s._v("compile")]),s._v("方法中打一个断点。")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('compile(callback) {\n    // 断点\n    \n    ...\n    this.applyPluginsAsync("before-compile", params, err => {\n        ...\n        this.applyPluginsParallel("make", compilation, err => {\n            ...\n            compilation.seal(err => {\n                ...\n                this.applyPluginsAsync("after-compile", compilation, err => {\n                    ...\n                });\n            });\n        });\n    });\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("p",[s._v("注意断点的位置，是在"),e("code",[s._v("compile")]),s._v("方法的入口处，"),e("br"),s._v("\n还没调用"),e("code",[s._v("compiler.hooks.make")]),s._v("，也没调用"),e("code",[s._v("compilation.seal")]),s._v("。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-67fdb662a4596e9a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/683/format/webp",alt:""}})]),s._v(" "),e("p",[s._v("然后，"),e("strong",[s._v("见证奇迹的时候到了")]),s._v("。。"),e("br"),s._v("\n我们按下"),e("code",[s._v("F5")]),s._v("，让程序继续运行，"),e("br"),s._v("\n结果程序运行了一会之后，"),e("strong",[s._v("又跑到了现在这个断点")]),s._v("。")]),s._v(" "),e("p",[s._v("这真是太奇怪了。"),e("br"),s._v("\n值得一提的是，"),e("code",[s._v("run")]),s._v("方法中的"),e("code",[s._v("this.compile")]),s._v("处如果打一个断点，"),e("br"),s._v("\n我们会发现"),e("code",[s._v("this.compile")]),s._v("却没有被第二次调用。")]),s._v(" "),e("h3",{attrs:{id:"_2-4-调用堆栈"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-调用堆栈"}},[s._v("#")]),s._v(" 2.4 调用堆栈")]),s._v(" "),e("p",[s._v("还好vscode的调试工具提供了查看"),e("strong",[s._v("调用堆栈")]),s._v("的功能，")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-253ca07fe544f765.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/656/format/webp",alt:""}})]),s._v(" "),e("p",[s._v("我们可以点击某个栈帧，来查看程序的执行过程。"),e("br"),s._v("\n点击第二行"),e("code",[s._v("runAsChild")]),s._v("，我们发现"),e("code",[s._v("this.compile")]),s._v("是由"),e("code",[s._v("runAsChild")]),s._v("调用的，"),e("br"),s._v(" "),e("code",[s._v("runAsChild")]),s._v("是"),e("code",[s._v("Compiler")]),s._v("类的实例方法，位于 "),e("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v3.11.0/lib/Compiler.js#L286",target:"_blank",rel:"noopener noreferrer"}},[s._v("Compiler.js 第286行"),e("OutboundLink")],1),s._v("。")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("runAsChild(callback) {\n    this.compile((err, compilation) => {\n        ...\n    });\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-a0d123da71cefa33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/557/format/webp",alt:""}})]),s._v(" "),e("p",[s._v("那么"),e("code",[s._v("runAsChild")]),s._v("是哪里调用的呢？"),e("br"),s._v("\n我们点击第三行"),e("code",[s._v("pitch")]),s._v("，结果"),e("code",[s._v("runAsChild")]),s._v("是由extract-text-webpack-plugin（v3.0.2）调用的，"),e("br"),s._v("\n代码位置在，"),e("a",{attrs:{href:"https://github.com/webpack-contrib/extract-text-webpack-plugin/blob/v3.0.2/src/loader.js#L81",target:"_blank",rel:"noopener noreferrer"}},[s._v("extract-text-webpack-plugin loader.js 第81行"),e("OutboundLink")],1),s._v("，")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("childCompiler.runAsChild((err, entries, compilation) => {\n    ...\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("这下就很清楚了，"),e("br"),s._v("\nextract-text-webpack-plugin创建了一个"),e("code",[s._v("childCompiler")]),s._v("，"),e("br"),s._v("\n然后调用了这个"),e("code",[s._v("childCompiler")]),s._v("的"),e("code",[s._v("runAsChild")]),s._v("方法，结果导致"),e("code",[s._v("this.compiler")]),s._v("再次被调用了。")]),s._v(" "),e("p",[s._v("extract-text-webpack-plugin这样做，会对我们调试"),e("code",[s._v("compiler.hooks.make")]),s._v("和"),e("code",[s._v("compilation.seal")]),s._v("产生困扰，"),e("br"),s._v("\n因为"),e("code",[s._v("this.compile")]),s._v("会触发两次，"),e("br"),s._v("\n结果"),e("code",[s._v("compiler.hooks.make")]),s._v("和"),e("code",[s._v("compilation.seal")]),s._v("也会触发两次。")]),s._v(" "),e("p",[e("strong",[s._v("注：")]),e("br"),s._v("\n每次加载一个 .less 文件，都会新建一个"),e("code",[s._v("childCompiler")]),s._v("，"),e("br"),s._v("\n因此，如果工程中用到了很多 .less 文件，"),e("br"),s._v(" "),e("code",[s._v("this.compile")]),s._v("方法会甚至会触发"),e("strong",[s._v("成百上千次")]),s._v("。")]),s._v(" "),e("p",[s._v("至于为什么会这样，我们继续往下看。")]),s._v(" "),e("h3",{attrs:{id:"_3-extract-text-webpack-plugin"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-extract-text-webpack-plugin"}},[s._v("#")]),s._v(" 3. extract-text-webpack-plugin")]),s._v(" "),e("h4",{attrs:{id:"_3-1-loader-execution"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-loader-execution"}},[s._v("#")]),s._v(" 3.1 LOADER_EXECUTION")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-3f26152eb890ebe5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/557/format/webp",alt:""}})]),s._v(" "),e("p",[s._v("我们继续跟踪调用堆栈，点到第四行"),e("code",[s._v("LOADER_EXECUTION")]),s._v("，"),e("br"),s._v("\n这个名字我们似曾相识，是的，我们在"),e("a",{attrs:{href:"https://www.jianshu.com/p/3ae8522fb098",target:"_blank",rel:"noopener noreferrer"}},[s._v("第四篇runLoaders"),e("OutboundLink")],1),s._v("一节介绍过它，"),e("br"),s._v("\n它位于 "),e("a",{attrs:{href:"https://github.com/webpack/loader-runner/blob/v2.3.1/lib/LoaderRunner.js#L118",target:"_blank",rel:"noopener noreferrer"}},[s._v("loader-runner LoaderRunner.js 第118行"),e("OutboundLink")],1),s._v("。")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("var result = (function LOADER_EXECUTION() {\n    return fn.apply(context, args);\n}());\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[e("code",[s._v("LOADER_EXECUTION")]),s._v("做的事情是，使用已载入的loader，来加载相匹配的资源。"),e("br"),s._v("\n此时，已载入的loader是extract-text-webpack-plugin extract方法返回的loader，"),e("br"),s._v("\n匹配的资源是待载入的less文件。")]),s._v(" "),e("p",[s._v("我们来验证下这个结论，在"),e("code",[s._v("LOADER_EXECUTION")]),s._v(" 函数中打个断点，"),e("br"),s._v("\n然后重新启动调试。")]),s._v(" "),e("p",[s._v("程序第一次来到这里的时候，是为了加载src/index.js，"),e("br"),s._v("\n体现在"),e("code",[s._v("context.resource")]),s._v("字段，")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("~/Test/debug-webpack3/src/index.js\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("然后我们按"),e("code",[s._v("F5")]),s._v("，等待程序第二次来到这里，"),e("br"),s._v("\n此时，"),e("code",[s._v("context.resource")]),s._v("变成了，")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("~/Test/debug-webpack3/src/index.less\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("表示当前正在加载 src/index.less。")]),s._v(" "),e("h4",{attrs:{id:"_3-2-childcompiler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-childcompiler"}},[s._v("#")]),s._v(" 3.2 childCompiler")]),s._v(" "),e("p",[s._v("现在我们用单步调试，进入到"),e("code",[s._v("fn.apply(context, args)")]),s._v("这个调用里面。"),e("br"),s._v("\n结果程序跳转到了 "),e("a",{attrs:{href:"https://github.com/webpack-contrib/extract-text-webpack-plugin/blob/v3.0.2/src/loader.js#L15",target:"_blank",rel:"noopener noreferrer"}},[s._v("extract-text-webpack-plugin loader.js pitch"),e("OutboundLink")],1),s._v("函数中。")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("export function pitch(request) {\n    ...\n    if (...) {\n        ...\n    } else if (...) {\n        ...\n    } else if (...) {\n        ...\n        const childCompiler = this._compilation.createChildCompiler(`extract-text-webpack-plugin ${NS} ${request}`, outputOptions);\n        ...\n        childCompiler.runAsChild((err, entries, compilation) => {\n            ...\n        });\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[s._v("看到了吧，每一次加载 .less文件，都会执行"),e("code",[s._v("LOADER_EXECUTION")]),s._v(" ，"),e("br"),s._v("\n每次执行"),e("code",[s._v("LOADER_EXECUTION")]),s._v(" 都会调用"),e("code",[s._v("pitch")]),s._v("函数，"),e("br"),s._v(" "),e("code",[s._v("pitch")]),s._v("函数中每次都会创建一个新的"),e("code",[s._v("childCompiler")]),s._v("，然后调用"),e("code",[s._v("childCompiler.runAsChild")]),s._v("。")]),s._v(" "),e("h4",{attrs:{id:"_3-3-this-compilation"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-this-compilation"}},[s._v("#")]),s._v(" 3.3 this._compilation")]),s._v(" "),e("p",[s._v("如果我们想知道"),e("code",[s._v("this._compilation.createChildCompiler")]),s._v(" 做了什么事情，"),e("br"),s._v("\n就必须知道"),e("code",[s._v("this._compilation")]),s._v("是怎么来的，"),e("br"),s._v("\n因此，也就必须搞清楚"),e("code",[s._v("this")]),s._v("是什么。")]),s._v(" "),e("p",[e("code",[s._v("this")]),s._v("实际上就是"),e("code",[s._v("pitch")]),s._v("的上下文，我们需要看"),e("code",[s._v("pitch")]),s._v("是如何被调用的，"),e("br"),s._v("\n翻看上文的调用链路，我们知道了，"),e("br"),s._v(" "),e("code",[s._v("pitch")]),s._v("是通过"),e("code",[s._v("fn.apply(context, args)")]),s._v("调用的，其中"),e("code",[s._v("fn")]),s._v("的值就是"),e("code",[s._v("pitch")]),s._v("。")]),s._v(" "),e("p",[s._v("因此，"),e("code",[s._v("pitch")]),s._v("中的"),e("code",[s._v("this")]),s._v("指向了"),e("code",[s._v("fn.apply(context, args)")]),s._v("中的"),e("code",[s._v("context")]),s._v("。"),e("br"),s._v("\n通过查看调用堆栈，我们最终定位到，"),e("br"),s._v("\n这个"),e("code",[s._v("context")]),s._v("是在 "),e("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v3.11.0/lib/NormalModule.js#L180",target:"_blank",rel:"noopener noreferrer"}},[s._v("webpack NormalModule.js doBuild"),e("OutboundLink")],1),s._v("中调用"),e("code",[s._v("createLoaderContext")]),s._v("创建的，")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("doBuild(options, compilation, resolver, fs, callback) {\n    ...\n    const loaderContext = this.createLoaderContext(resolver, options, compilation, fs);\n\n    runLoaders({\n        ...\n        context: loaderContext,\n        ...\n    }, (err, result) => {\n        ...\n    });\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[e("code",[s._v("createLoaderContext")]),s._v("是"),e("code",[s._v("NormalModule")]),s._v("的实例方法，"),e("br"),s._v("\n它的定义在，"),e("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v3.11.0/lib/NormalModule.js#L112",target:"_blank",rel:"noopener noreferrer"}},[s._v("NormalModule.js 第112行"),e("OutboundLink")],1),s._v("，")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("createLoaderContext(resolver, options, compilation, fs) {\n    const loaderContext = {\n        ...\n        _compilation: compilation,\n        ...\n    };\n    ...\n    return loaderContext;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("因此，这个"),e("code",[s._v("_compilation")]),s._v("，就是"),e("code",[s._v("doBuild")]),s._v("参数中的"),e("code",[s._v("compiation")]),s._v("。"),e("br"),s._v("\n而这个"),e("code",[s._v("compiler")]),s._v("就是在"),e("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v3.11.0/lib/Compiler.js#L497",target:"_blank",rel:"noopener noreferrer"}},[s._v("Compiler.js中第497行"),e("OutboundLink")],1),s._v("，触发"),e("code",[s._v("compiler.hooks.make")]),s._v("之前新建的那个"),e("code",[s._v("compilation")]),s._v("。")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('const compilation = this.newCompilation(params);\nthis.applyPluginsParallel("make", compilation, err => {\n   ...\n});\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h4",{attrs:{id:"_3-4-this-compilation-createchildcompiler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-this-compilation-createchildcompiler"}},[s._v("#")]),s._v(" 3.4 this._compilation.createChildCompiler")]),s._v(" "),e("p",[s._v("我们就可以去"),e("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v3.11.0/lib/Compilation.js#L1416",target:"_blank",rel:"noopener noreferrer"}},[s._v("Compilation.js 第1416行"),e("OutboundLink")],1),s._v("中查看"),e("code",[s._v("createChildCompiler")]),s._v("方法了，")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("createChildCompiler(name, outputOptions, plugins) {\n    ...\n    return this.compiler.createChildCompiler(this, name, idx, outputOptions, plugins);\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("它调用了"),e("code",[s._v("compiler.createChildCompiler")]),s._v("，在"),e("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v3.11.0/lib/Compiler.js#L413",target:"_blank",rel:"noopener noreferrer"}},[s._v("Compiler.js 第413行"),e("OutboundLink")],1),s._v("，")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('createChildCompiler(compilation, compilerName, compilerIndex, outputOptions, plugins) {\n    const childCompiler = new Compiler();\n    ...\n    for(const name in this._plugins) {\n        if(["make", "compile", "emit", "after-emit", "invalid", "done", "this-compilation"].indexOf(name) < 0)\n            childCompiler._plugins[name] = this._plugins[name].slice();\n    }\n    ...\n    compilation.applyPlugins("child-compiler", childCompiler, compilerName, compilerIndex);\n\n    return childCompiler;\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("它会新建一个"),e("code",[s._v("Compiler")]),s._v("实例，然后把原来父"),e("code",[s._v("compiler")]),s._v("上的"),e("code",[s._v("_plugins")]),s._v("都"),e("strong",[s._v("浅拷贝")]),s._v("过去。"),e("br"),s._v("\n因此，以前挂载在"),e("code",[s._v("compiler")]),s._v("上的hooks同样也会挂载到"),e("code",[s._v("childCompiler")]),s._v("上，"),e("br"),s._v("\n只是，当hooks被调用时，才会触发回调。")]),s._v(" "),e("p",[s._v("其中"),e("code",[s._v('"make", "compile", "emit", "after-emit", "invalid", "done", "this-compilation"')]),s._v("，"),e("br"),s._v("\n这些"),e("code",[s._v("_plugin")]),s._v("不拷贝。")]),s._v(" "),e("p",[s._v("假如我们写了一个这样的webpack3插件，"),e("br"),s._v("\n（只需将webpack4中插件的写法从hooks改成plugin即可)")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("class Plugin {\n    apply(compiler) {\n        compiler.plugin('compilation', compilation => {\n            compilation.plugin('seal', () => {\n                ...\n            });\n        });\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("则当"),e("code",[s._v("childCompiler")]),s._v("调用"),e("code",[s._v("compiler.hooks.compilation")]),s._v("时，"),e("br"),s._v("\n以上为父"),e("code",[s._v("compiler")]),s._v("注册的事件也会在"),e("code",[s._v("childCompiler")]),s._v("上触发，"),e("br"),s._v("\n唯一不同是参数"),e("code",[s._v("compilation")]),s._v("不同。")]),s._v(" "),e("p",[s._v("所以接下来，"),e("code",[s._v("compilation.plugin('seal', () => {")]),s._v(" ，"),e("br"),s._v("\n就为这个新"),e("code",[s._v("compilation")]),s._v("实现了一个新的"),e("code",[s._v("hooks.seal")]),s._v("。")]),s._v(" "),e("h4",{attrs:{id:"_3-5-hooks的多次触发"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-hooks的多次触发"}},[s._v("#")]),s._v(" 3.5 hooks的多次触发")]),s._v(" "),e("p",[s._v("我们来看下实际使用这个插件时的日志信息。")]),s._v(" "),e("p",[e("strong",[s._v("（1）新建plugin.js")])]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("const log = require('debug')('debug-webpack plugin.js');\n\nclass Plugin {\n    apply(compiler) {\n        compiler.plugin('compilation', compilation => {\n            log('in: compilation');\n            compilation.plugin('seal', () => {\n                log('in: seal, compilation.entries: %s', compilation.entries.map(({ resource }) => resource).join());\n            });\n        });\n    }\n}\n\nmodule.exports = Plugin;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[e("strong",[s._v("（2）在webpack.config.js中使用它")])]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("...\nconst Plugin = require('./plugin');\n\nmodule.exports = {\n    ...\n    plugins: [\n        ...\n        new Plugin,\n    ]\n};\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[e("strong",[s._v("（3）运行一下")])]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$ DEBUG=debug-wepack* npm run build\n\n> debug-webpack3@1.0.0 build ~/Test/debug-webpack3\n> webpack\n\n  debug-webpack plugin.js in: compilation +0ms\n  debug-webpack plugin.js in: seal, compilation.entries: ~/Test/debug-webpack3/src/index.js +600ms\n  debug-webpack plugin.js in: compilation +7ms\n  debug-webpack plugin.js in: seal, compilation.entries: ~/Test/debug-webpack3/src/index.less +28ms\nHash: 1b8999f3bb679ecffd56\nVersion: webpack 3.11.0\nTime: 657ms\n    Asset      Size  Chunks             Chunk Names\n index.js   2.64 kB       0  [emitted]  index\nindex.css  29 bytes       0  [emitted]  index\n   [0] ./src/index.js 49 bytes {0} [built]\n   [1] ./src/index.less 41 bytes {0} [built]\n    + 1 hidden module\nChild extract-text-webpack-plugin node_modules/_extract-text-webpack-plugin@3.0.2@extract-text-webpack-plugin/dist node_modules/_css-loader@0.28.10@css-loader/index.js!node_modules/_less-loader@4.0.6@less-loader/dist/cjs.js!src/index.less:\n       [0] ./node_modules/_css-loader@0.28.10@css-loader!./node_modules/_less-loader@4.0.6@less-loader/dist/cjs.js!./src/index.less 211 bytes {0} [built]\n        + 1 hidden module\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br")])]),e("p",[s._v("我们看到"),e("code",[s._v("compilation.hooks.seal")]),s._v("总共触发了两次，"),e("br"),s._v("\n第一次的entry是~/Test/debug-webpack3/src/index.js，"),e("br"),s._v("\n第二次为~/Test/debug-webpack3/src/index.less。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-99af71bf782fdd19.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511/format/webp",alt:""}})]),s._v(" "),e("p",[s._v("第二次 .less 文件触发"),e("code",[s._v("compilation.hooks.seal")]),s._v("的流程如下，"),e("br"),s._v("\nwebpack在加载 .less 文件时，使用了extract-text-webpack-plugin，"),e("br"),s._v("\n每次加载一个 .less 文件，都会创建一个新的 "),e("code",[s._v("childCompiler")]),s._v("。")]),s._v(" "),e("p",[s._v("这个"),e("code",[s._v("childCompiler")]),s._v("会把父"),e("code",[s._v("compiler")]),s._v("中所有的hooks都拷贝过去，"),e("br"),s._v("\n然后就调用了"),e("code",[s._v("childCompiler.runAsChild")]),s._v("，它会调用"),e("code",[s._v("this.compile")]),s._v("，此时"),e("code",[s._v("this")]),s._v("是"),e("code",[s._v("childCompiler")]),s._v("，"),e("br"),s._v("\n然后"),e("code",[s._v("this.compile")]),s._v("中，会触发"),e("code",[s._v("compiler.hooks.compilation")]),s._v("这个hooks（"),e("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v3.11.0/lib/Compiler.js#L465",target:"_blank",rel:"noopener noreferrer"}},[s._v("见Compiler.js 第465行"),e("OutboundLink")],1),s._v("）。")]),s._v(" "),e("p",[s._v("这个hooks是从父"),e("code",[s._v("compiler")]),s._v("那里拷贝过来的，"),e("br"),s._v("\n因此就会触发我们的插件注册的那个回调，只是传入一个新创建的"),e("code",[s._v("compilation")]),s._v("实例作为参数。")]),s._v(" "),e("p",[s._v("**")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("compiler.plugin('compilation', compilation => {\n    ...\n});\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("接着为这个新"),e("code",[s._v("compilation")]),s._v("实例，在这个回调中注册了"),e("code",[s._v("compilation.hooks.seal")]),s._v("事件。"),e("br"),s._v("\n然后webpack在对 .less 文件 seal的时候，触发"),e("code",[s._v("hooks.seal")]),s._v("事件时，就引发了这个回调。")]),s._v(" "),e("hr"),s._v(" "),e("h3",{attrs:{id:"参考"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/webpack-contrib/extract-text-webpack-plugin/issues/701",target:"_blank",rel:"noopener noreferrer"}},[s._v("extract-text-webpack-plugin: Webpack 4 compatibility"),e("OutboundLink")],1),e("br"),s._v(" "),e("a",{attrs:{href:"https://github.com/webpack/webpack/tree/v3.11.0",target:"_blank",rel:"noopener noreferrer"}},[s._v("webpack v3.11.0"),e("OutboundLink")],1),e("br"),s._v(" "),e("a",{attrs:{href:"https://github.com/webpack/webpack/tree/v4.20.2",target:"_blank",rel:"noopener noreferrer"}},[s._v("webpack v4.20.2"),e("OutboundLink")],1),e("br"),s._v(" "),e("a",{attrs:{href:"https://github.com/webpack/loader-runner/tree/v2.3.1",target:"_blank",rel:"noopener noreferrer"}},[s._v("loader-runner v2.3.1"),e("OutboundLink")],1)])])}),[],!1,null,null,null);e.default=t.exports}}]);