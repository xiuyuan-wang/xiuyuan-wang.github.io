(window.webpackJsonp=window.webpackJsonp||[]).push([[114],{307:function(e,s,n){"use strict";n.r(s);var a=n(14),r=Object(a.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h3",{attrs:{id:"_1-回顾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-回顾"}},[e._v("#")]),e._v(" 1. 回顾")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-2e2ebf410721d5e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/553/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("上文我们介绍了webpack在"),s("strong",[e._v("代码生成阶段")]),e._v("做的事情。")]),e._v(" "),s("p",[e._v("我们知道，webpack调用了"),s("code",[e._v("compiler.hooks.make")]),e._v("加载资源，"),s("br"),e._v("\n它会先加载loader，然后用loader加载源文件，"),s("br"),e._v("\n对于js而言，babel-loader会返回转换后的es5代码，而"),s("strong",[e._v("不是AST")]),e._v("。")]),e._v(" "),s("p",[e._v("加载完资源之后，webpack就会调用"),s("code",[e._v("compilation.seal")]),e._v("来生成代码，"),s("br"),e._v(" "),s("code",[e._v("compilation.seal")]),e._v("中调用了一大堆hooks，"),s("br"),e._v("\n其中最重要的两件事情是，"),s("code",[e._v("createChunkAssets")]),e._v("和"),s("code",[e._v("optimizeChunkAssets")]),e._v("。")]),e._v(" "),s("p",[e._v("（1）"),s("code",[e._v("createChunkAssets")]),e._v("会填充"),s("code",[e._v("compilation.assets")]),e._v("对象，"),s("br"),e._v(" "),s("code",[e._v("compilation.assets")]),e._v("中保存了待生成的目标文件名，和文件内容。")]),e._v(" "),s("p",[e._v("（2）"),s("code",[e._v("optimizeChunkAssets")]),e._v("会调用uglifyjs-webpack-plugin进行代码压缩，"),s("br"),e._v("\n而uglifyjs-webpack-plugin则引用了"),s("strong",[e._v("uglify-es")]),e._v("，"),s("strong",[e._v("worker-farm")]),e._v("协助完成工作。")]),e._v(" "),s("p",[e._v("本文就从uglifyjs-webpack-plugin开始介绍，"),s("br"),e._v("\n其中worker-farm还涉及了Node.js内置模块"),s("strong",[e._v("child_process")]),e._v("。")]),e._v(" "),s("h3",{attrs:{id:"_2-进入uglifyjs-wepack-plugin"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-进入uglifyjs-wepack-plugin"}},[e._v("#")]),e._v(" 2. 进入uglifyjs-wepack-plugin")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-8e1106e79bdf86b0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/350/format/webp",alt:""}})]),e._v(" "),s("h4",{attrs:{id:"_2-1-compilation-hooks-optimizechunkassets"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-compilation-hooks-optimizechunkassets"}},[e._v("#")]),e._v(" 2.1 compilation.hooks.optimizeChunkAssets")]),e._v(" "),s("p",[e._v("上一篇中我们介绍了，之所以会用到uglifyjs-wepack-plugin，"),s("br"),e._v("\n是因为"),s("code",[e._v("compilation.seal")]),e._v("中调用了"),s("code",[e._v("compilation.hooks.optimizeChunkAssets")]),e._v("。")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-d182e121564a8161.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/347/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("而compilation.hooks.optimizeChunkAssets的"),s("strong",[e._v("实现")]),e._v("，位于"),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/index.js#L339",target:"_blank",rel:"noopener noreferrer"}},[e._v(" uglifyjs-webpack-plugin/src/index.js 第339行"),s("OutboundLink")],1),e._v("。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("compilation.hooks.optimizeChunkAssets.tapAsync(plugin, optimizeFn.bind(this, compilation));\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("该hooks的代码逻辑主要位于"),s("code",[e._v("optimizeFn")]),e._v(" 中，它在 "),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/index.js#L130",target:"_blank",rel:"noopener noreferrer"}},[e._v("index.js 第138行"),s("OutboundLink")],1),e._v("。")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-ec998989211488d7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/343/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("const optimizeFn = (compilation, chunks, callback) => {\n    ...\n    runner.runTasks(tasks, (tasksError, results) => {\n        ...\n        callback();\n    });\n};\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("h4",{attrs:{id:"_2-2-runner-runtasks"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-runner-runtasks"}},[e._v("#")]),e._v(" 2.2 runner.runTasks")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-14ff11cf9907d33c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/347/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("我们看到，"),s("code",[e._v("optimizeFn")]),e._v(" 函数调用了"),s("code",[e._v("runner.runTasks")]),e._v("，"),s("br"),e._v("\n其中"),s("code",[e._v("runner")]),e._v("是由 "),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/uglify/Runner.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("uglifyjs-webpack-plugin/src/uglify/Runner.js"),s("OutboundLink")],1),e._v(" 导出的。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("export default class Runner {\n    ...\n    runTasks(tasks, callback) {\n        ...\n    }\n    ...\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("p",[s("code",[e._v("runTasks")]),e._v("方法在 "),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/uglify/Runner.js#L25",target:"_blank",rel:"noopener noreferrer"}},[e._v("Runner.js 第25行"),s("OutboundLink")],1),e._v("。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("runTasks(tasks, callback) {\n    ...\n    if (this.maxConcurrentWorkers > 1) {\n        ...\n        this.workers = workerFarm(workerOptions, workerFile);\n        this.boundWorkers = (options, cb) => this.workers(serialize(options), cb);\n    } else {\n        this.boundWorkers = (options, cb) => {\n            ...\n            cb(null, minify(options));\n        };\n    }\n    ...\n    const step = (index, data) => {\n        ...\n        callback(null, results);\n    };\n\n    tasks.forEach((task, index) => {\n        const enqueue = () => {\n            this.boundWorkers(task, (error, data) => {\n                ...\n                const done = () => step(index, result);\n                ...\n                done();\n            });\n        };\n\n        ...\n        cacache.get(this.cacheDir, serialize(task.cacheKeys)).then(({ data }) => step(index, JSON.parse(data)), enqueue);\n    });\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br")])]),s("p",[e._v("下面我们仔细分析一下这个函数，这是一个"),s("strong",[e._v("关键点")]),e._v("。")]),e._v(" "),s("p",[s("strong",[e._v("（1）parallel 模式")]),s("br"),e._v("\n首先，"),s("code",[e._v("if (this.maxConcurrentWorkers > 1) {")]),e._v(" ，这个条件，"),s("br"),e._v("\n是判断 uglifyjs-webpack-plugin是否开启了"),s("code",[e._v("parallel")]),e._v("，可参考github仓库中的文档，"),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/README.md#options",target:"_blank",rel:"noopener noreferrer"}},[e._v("README.md #Options"),s("OutboundLink")],1),e._v("。")]),e._v(" "),s("p",[e._v("值得注意的是，这里虽然文档上写了"),s("code",[e._v("parallel")]),e._v("默认为"),s("code",[e._v("false")]),e._v("，"),s("br"),e._v("\n但是webpack内部集成uglifyjs-webpack-plugin的时候，显式传入了"),s("code",[e._v("true")]),e._v("，"),s("br"),e._v("\n代码位于，"),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/WebpackOptionsDefaulter.js#L310",target:"_blank",rel:"noopener noreferrer"}},[e._v("webpack/lib/WebpackOptionsDefaulter.js 第310行"),s("OutboundLink")],1),e._v("。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('this.set("optimization.minimizer", "make", options => [\n    {\n        apply: compiler => {\n            // Lazy load the uglifyjs plugin\n            const UglifyJsPlugin = require("uglifyjs-webpack-plugin");\n            const SourceMapDevToolPlugin = require("./SourceMapDevToolPlugin");\n            new UglifyJsPlugin({\n                cache: true,\n                parallel: true,\n                sourceMap:\n                    (options.devtool && /source-?map/.test(options.devtool)) ||\n                    (options.plugins &&\n                        options.plugins.some(p => p instanceof SourceMapDevToolPlugin))\n            }).apply(compiler);\n        }\n    }\n]);\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br")])]),s("p",[e._v("所以，我们使用示例工程进行调试的时候，"),s("code",[e._v("if (this.maxConcurrentWorkers > 1) {")]),e._v(" 为真，"),s("br"),e._v("\n表示启用了parallel模式进行压缩。")]),e._v(" "),s("p",[s("strong",[e._v("注：")]),s("br"),e._v("\n如果我们在webpack.config.js中，手动引入uglifyjs-webpack-plugin，并设置"),s("code",[e._v("parallel")]),e._v("为"),s("code",[e._v("false")]),e._v("，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("...\nconst UglifyJsPlugin = require('uglifyjs-webpack-plugin');\n\nmodule.exports = {\n    ...\n    plugins: [\n        new UglifyJsPlugin({\n            parallel: false,\n        }),\n    ],\n    ...\n};\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br")])]),s("p",[e._v("就会关闭parallel模式，逻辑走到这里，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("else {\n    this.boundWorkers = (options, cb) => {\n        ...\n        cb(null, minify(options));\n    };\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("p",[s("code",[e._v("this.boundWorkers")]),e._v("的值绑定为不同的值。"),s("br"),e._v(" "),s("code",[e._v("this.boundWorkers")]),e._v("什么时候被调用，我们之后再详细介绍（本文第2.3节）。")]),e._v(" "),s("p",[s("strong",[e._v("（2）worker-farm")])]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-2393b8b9a0294541.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/353/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("下面我们再回到parallel模式，parallel模式中会调用"),s("code",[e._v("workerFarm")]),e._v("创"),s("code",[e._v("建workers")]),e._v("，"),s("br"),e._v("\n最后，"),s("code",[e._v("this.boundWorkers")]),e._v("的调用会导致"),s("code",[e._v("workers")]),e._v("被调用。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("if (this.maxConcurrentWorkers > 1) {\n    ...\n    this.workers = workerFarm(workerOptions, workerFile);\n    this.boundWorkers = (options, cb) => this.workers(serialize(options), cb);\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br")])]),s("p",[e._v("可是"),s("code",[e._v("workers")]),e._v(" 是什么呢？"),s("code",[e._v("workerFarm")]),e._v("又是什么？"),s("br"),e._v("\nworkerFarm实际上是引用了一个独立的代码库，"),s("a",{attrs:{href:"https://github.com/rvagg/node-worker-farm/tree/v1.6.0",target:"_blank",rel:"noopener noreferrer"}},[e._v("worker-farm"),s("OutboundLink")],1),e._v("（v1.6.0）。"),s("br"),e._v("\n它内部会调用Node.js内置模块"),s("strong",[e._v("child_process")]),e._v("来完成任务。")]),e._v(" "),s("p",[e._v("具体用法如下，"),s("br"),e._v("\n首先我们要新建一个child.js文件，子进程中会执行这些代码，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("module.exports = function (inp, callback) {\n  callback(null, inp + ' BAR (' + process.pid + ')')\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("然后我们在main.js文件中，使用worker-farm开启子进程，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("var workerFarm = require('worker-farm')\n  , workers    = workerFarm(require.resolve('./child'))\n  , ret        = 0\n\nfor (var i = 0; i < 10; i++) {\n  workers('#' + i + ' FOO', function (err, outp) {\n    console.log(outp)\n    if (++ret == 10)\n      workerFarm.end(workers)\n  })\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br")])]),s("p",[e._v("以上代码，只有到了第"),s("code",[e._v("6")]),e._v("行workers被调用的时候，"),s("br"),e._v("\nNode.js才会加载并执行子进程中的代码，"),s("br"),e._v("\n被加载的子进程文件，我们可以查看下"),s("code",[e._v("workerFile")]),e._v("，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("~/Test/debug-webpack/node_modules/_uglifyjs-webpack-plugin@1.3.0@uglifyjs-webpack-plugin/dist/uglify/worker.js\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("源代码位置，位于"),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/uglify/worker.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("uglifyjs-webpack-plugin/src/uglify/worker.js"),s("OutboundLink")],1),e._v("，"),s("br"),e._v("\n其中，"),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/uglify/worker.js#L17",target:"_blank",rel:"noopener noreferrer"}},[e._v("第17行"),s("OutboundLink")],1),e._v("，调用了"),s("code",[e._v("minify")]),e._v("来进行代码压缩。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("callback(null, minify(options));\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("worker-farm的内部逻辑，我们这里暂且略过，"),s("br"),e._v("\n唯一会引起我们困扰的是，child.js中"),s("strong",[e._v("无法打断点")]),e._v("，使用vscode调试的时候，也不会跳进去。"),s("br"),e._v("\n所以，我们只能在里面写log来"),s("strong",[e._v("确定child.js执行了")]),e._v("。")]),e._v(" "),s("p",[e._v("child.js中代码执行完了之后，调用"),s("code",[e._v("callback")]),e._v("，会触发main.js 中"),s("code",[e._v("workers")]),e._v("的回调。"),s("br"),e._v("\n因此对于uglifyjs-webpack-plugin而言，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("this.boundWorkers = (options, cb) => this.workers(serialize(options), cb);\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[s("code",[e._v("this.workers")]),e._v("中工作做完后，会导致"),s("code",[e._v("this.boundWorkers")]),e._v("的回调"),s("code",[e._v("cb")]),e._v("被触发。")]),e._v(" "),s("p",[s("strong",[e._v("（3）一路callback")])]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-5afaeb8a2c3bdb3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/355/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("我们再来看下"),s("code",[e._v("runTasks")]),e._v("的代码，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("runTasks(tasks, callback) {\n    ...\n    if (this.maxConcurrentWorkers > 1) {\n        ...\n        this.workers = workerFarm(workerOptions, workerFile);\n        this.boundWorkers = (options, cb) => this.workers(serialize(options), cb);\n    } else {\n        this.boundWorkers = (options, cb) => {\n            ...\n            cb(null, minify(options));\n        };\n    }\n    ...\n    const step = (index, data) => {\n        ...\n        callback(null, results);\n    };\n\n    tasks.forEach((task, index) => {\n        const enqueue = () => {\n            this.boundWorkers(task, (error, data) => {\n                ...\n                const done = () => step(index, result);\n                ...\n                done();\n            });\n        };\n\n        ...\n        cacache.get(this.cacheDir, serialize(task.cacheKeys)).then(({ data }) => step(index, JSON.parse(data)), enqueue);\n    });\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br")])]),s("p",[e._v("以上代码第"),s("code",[e._v("6")]),e._v("行，"),s("code",[e._v("this.workers")]),e._v("完成后回调，会导致"),s("code",[e._v("this.boundWorkers")]),e._v("返回，"),s("br"),e._v(" "),s("code",[e._v("this.boundWorkers")]),e._v("返回，在第23行，会调用"),s("code",[e._v("done();")]),s("br"),e._v(" "),s("code",[e._v("done();")]),e._v(" 会调用"),s("code",[e._v("step")]),e._v("，"),s("code",[e._v("step")]),e._v("会调用"),s("code",[e._v("callback")]),e._v("。")]),e._v(" "),s("p",[s("code",[e._v("step")]),e._v("中的"),s("code",[e._v("callback")]),e._v("，就是"),s("code",[e._v("runTasks")]),e._v("的"),s("code",[e._v("callback")]),e._v("。"),s("br"),e._v("\n这样"),s("code",[e._v("runTasks")]),e._v("就结束了，回到了"),s("code",[e._v("optimizeFn")]),e._v("中，继而完成了"),s("code",[e._v("compilation.hooks.optimizeChunkAssets")]),e._v("，"),s("br"),e._v("\n最终回到了"),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L1283",target:"_blank",rel:"noopener noreferrer"}},[e._v(" Compilation.js"),s("OutboundLink")],1),e._v(" 中，"),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L1283",target:"_blank",rel:"noopener noreferrer"}},[e._v("第1283行"),s("OutboundLink")],1),e._v("。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("this.hooks.optimizeChunkAssets.callAsync(this.chunks, err => {\n    // 这里\n});\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("这样就完成"),s("code",[e._v("compilation.hooks.optimizeChunkAssets")]),e._v("调用了。")]),e._v(" "),s("h4",{attrs:{id:"_2-3-enqueue"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-enqueue"}},[e._v("#")]),e._v(" 2.3 enqueue")]),e._v(" "),s("p",[e._v("上文中我们留下了一个疑问，"),s("code",[e._v("this.boundWorkers")]),e._v("到底是什么时候触发的呢？"),s("br"),e._v("\n答案是，它是在runTasks中"),s("code",[e._v("enqueue")]),e._v("函数里触发的。")]),e._v(" "),s("p",[e._v("源码位于，"),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/uglify/Runner.js#L59",target:"_blank",rel:"noopener noreferrer"}},[e._v("Runner.js 第59行"),s("OutboundLink")],1),e._v("，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("tasks.forEach((task, index) => {\n    const enqueue = () => {\n        this.boundWorkers(task, (error, data) => {\n            ...\n        });\n    };\n\n    if (this.cacheDir) {\n        cacache.get(this.cacheDir, serialize(task.cacheKeys)).then(({ data }) => step(index, JSON.parse(data)), enqueue);\n    } else {\n        enqueue();\n    }\n});\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br")])]),s("p",[e._v("而"),s("code",[e._v("enqueue")]),e._v("可能会由"),s("code",[e._v("cacahe.get")]),e._v("调用，也可能在"),s("code",[e._v("else")]),e._v("语句中直接调用。")]),e._v(" "),s("p",[s("strong",[e._v("（1）cacache缓存")])]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-4fdde743de3f8729.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/362/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("通过调试，我们发现，"),s("code",[e._v("cacheDir")]),e._v("总是有值的，默认开启了缓存，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("~/Test/debug-webpack/node_modules/.cache/uglifyjs-webpack-plugin\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("我们进入该目录查看一下文件结构，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("uglifyjs-webpack-plugin\n├── content-v2\n│   └── sha512\n│       └── d9\n│           └── 62\n│               └── a6889cb7fcb5f74679b4995fc488b42058fa7d1974386c75e566747c31bff92b1690152d887937e411caa9618019c796801b4879f3c927bff72da41e4080\n├── index-v5\n│   └── f9\n│       └── 62\n│           └── ab8974c954e9577998f607845e6ff5dc6acf034140aaf851b6a3fbf93ead\n└── tmp\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br")])]),s("p",[e._v("其中，content-v2/sha512/d9/62/... 那个长文件的内容如下，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('{"code":"!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t){}]);","extractedComments":[]}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("index-v5/f9/62/... 这个长文件的内容如下，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('3f12b2ef5f09ba45b021cbeb26a3b0356b1e42df    {\n    "key": "{"uglify-es":"3.3.9","uglifyjs-webpack-plugin":"1.3.0","uglifyjs-webpack-plugin-options":{"test":/\\.js(\\?.*)?$/i,"warningsFilter":function () {\\n      return true;\\n    },"extractComments":false,"sourceMap":false,"cache":true,"cacheKeys":function (defaultCacheKeys) {\\n      return defaultCacheKeys;\\n    },"parallel":true,"uglifyOptions":{"compress":{"inline":1},"output":{"comments":/^\\**!|@preserve|@license|@cc_on/}}},"path":"\\u002FUsers\\u002Fthzt\\u002FTest\\u002Fdebug-webpack\\u002Fdist\\u002Findex.js","hash":"27c9fda4f852c4a1e09c203bd9f77a56"}",\n    "integrity": "sha512-2WKmiJy3/LX3Rnm0mV/EiLQgWPp9GXQ4bHXlZnR8Mb/5KxaQFS2IeTfkEcqpYYAZx5aAG0h588knv/ctpB5AgA==",\n    "time": 1540290187493,\n    "size": 980\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("p",[e._v("它们分别存储了缓存的"),s("code",[e._v("key")]),e._v("和"),s("code",[e._v("value")]),e._v("，"),s("code",[e._v("value")]),e._v("就是uglifyjs "),s("code",[e._v("minify")]),e._v("后的代码。")]),e._v(" "),s("p",[s("strong",[e._v("（2）then(..., enqueue)")]),s("br"),e._v("\n如果有缓存，就不会触发"),s("code",[e._v("enqueue")]),e._v("，也就不会触发"),s("code",[e._v("this.boundWorkers")]),e._v("，继而不会触发"),s("code",[e._v("this.workers")]),e._v("被调用，"),s("br"),e._v("\n代码就不会再次被"),s("code",[e._v("minify")]),e._v("了。")]),e._v(" "),s("p",[e._v("而如果没有缓存，会发生什么呢？"),s("br"),e._v("\n我们把缓存目录删掉，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("~/Test/debug-webpack/node_modules/.cache/uglifyjs-webpack-plugin\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("通过逐行调试，我们发现最终在 "),s("a",{attrs:{href:"https://github.com/zkat/cacache/blob/v10.0.4/get.js#L38",target:"_blank",rel:"noopener noreferrer"}},[e._v("cacache/get.js 第38行"),s("OutboundLink")],1),e._v(" 抛了一个异常，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("return (\n    ...\n  ).then(entry => {\n    if (...) {\n      throw new index.NotFoundError(cache, key)\n    }\n    ...\n  })\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("p",[e._v("这个异常是在"),s("code",[e._v("promise.then")]),e._v("中抛出的，"),s("br"),e._v("\n因此，"),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/uglify/Runner.js#L72",target:"_blank",rel:"noopener noreferrer"}},[e._v("Runner.js 第72行"),s("OutboundLink")],1),e._v("，调用"),s("code",[e._v("cacahe.get")]),e._v("的地方，就会触发"),s("code",[e._v("then")]),e._v("的第二个回调参数，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("cacache.get(this.cacheDir, serialize(task.cacheKeys)).then(({ data }) => step(index, JSON.parse(data)), enqueue);\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("这个回调正好是"),s("code",[e._v("enqueue")]),e._v("。")]),e._v(" "),s("p",[s("strong",[e._v("欲知后事如何，且待我下回分解。")])]),e._v(" "),s("hr"),e._v(" "),s("h3",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[e._v("#")]),e._v(" 参考")]),e._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/tree/v1.3.0",target:"_blank",rel:"noopener noreferrer"}},[e._v("uglifyjs-webpack-plugin v1.3.0"),s("OutboundLink")],1),s("br"),e._v(" "),s("a",{attrs:{href:"https://github.com/rvagg/node-worker-farm/tree/v1.6.0",target:"_blank",rel:"noopener noreferrer"}},[e._v("worker-farm v1.6.0"),s("OutboundLink")],1),s("br"),e._v(" "),s("a",{attrs:{href:"https://github.com/zkat/cacache/tree/v10.0.4",target:"_blank",rel:"noopener noreferrer"}},[e._v("cacache v10.0.4"),s("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=r.exports}}]);