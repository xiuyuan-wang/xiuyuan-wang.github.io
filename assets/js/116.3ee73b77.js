(window.webpackJsonp=window.webpackJsonp||[]).push([[116],{297:function(e,a,s){"use strict";s.r(a);var n=s(14),t=Object(n.a)({},(function(){var e=this,a=e._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("p",[e._v("本系列文章记录了我在"),a("strong",[e._v("webpack源码学习过程中")]),e._v("遇到的事情，"),a("br"),e._v("\n正如前几篇文章介绍的那样，"),a("br"),e._v("\n一路上我遇到了很多“"),a("strong",[e._v("江湖人物")]),e._v("”。")]),e._v(" "),a("p",[e._v("例如，Compiler，Compilation，loader-runner，babel-loader，"),a("br"),e._v("\ntapable，uglifyjs-webpack-plugin，worker-farm，cacahe，extract-text-webpack-plugin，等等。")]),e._v(" "),a("p",[e._v("所以我们可以说，"),a("strong",[e._v("webpack江湖")]),e._v("是由这些“人物”组成的，而不是由文本组成的，"),a("br"),e._v("\n这正是"),a("strong",[e._v("面向对象编程")]),e._v("，和模块化编程的"),a("strong",[e._v("精髓")]),e._v("所在。")]),e._v(" "),a("p",[e._v("就好比金庸先生的武侠小说，"),a("br"),e._v("\n引人入胜的"),a("strong",[e._v("故事情节")]),e._v("，离不开鲜活的"),a("strong",[e._v("人物形象")]),e._v("。")]),e._v(" "),a("p",[e._v("在代码的世界中，"),a("br"),e._v("\n我们看到的各种“人物”，也是真实存在的，"),a("br"),e._v("\n它们反映了作者对"),a("strong",[e._v("信息组织方式")]),e._v("的理解和认知。")]),e._v(" "),a("p",[e._v("故事由哪些"),a("strong",[e._v("人物")]),e._v("组成，"),a("strong",[e._v("主线剧情")]),e._v("是什么，"),a("br"),e._v("\n哪些情节要详细介绍，哪些应该略过不表，"),a("br"),e._v("\n这些都是把故事"),a("strong",[e._v("讲清楚")]),e._v("而不得不考虑的事情。")]),e._v(" "),a("p",[e._v("本文我们继续学习webpack源码，"),a("br"),e._v("\n了解webpack是怎样watch文件变更的。")]),e._v(" "),a("h3",{attrs:{id:"_1-修改npm-scripts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-修改npm-scripts"}},[e._v("#")]),e._v(" 1. 修改npm scripts")]),e._v(" "),a("h4",{attrs:{id:"_1-1-加入watch命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-加入watch命令"}},[e._v("#")]),e._v(" 1.1 加入watch命令")]),e._v(" "),a("p",[e._v("我们修改"),a("a",{attrs:{href:"https://www.jianshu.com/p/2fa6562210ef",target:"_blank",rel:"noopener noreferrer"}},[e._v("debug-webpack"),a("OutboundLink")],1),e._v("项目的package.json，增加一个新的npm scripts，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('{\n  ...\n  "scripts": {\n    ...\n    "watch": "webpack --watch"\n  },\n  ...\n}\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br")])]),a("p",[e._v("这样我们就可以使用"),a("code",[e._v("npm run watch")]),e._v("来调用 "),a("code",[e._v("node_modules/.bin/webpack --watch")]),e._v("了。")]),e._v(" "),a("h4",{attrs:{id:"_1-2-执行watch"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-执行watch"}},[e._v("#")]),e._v(" 1.2 执行watch")]),e._v(" "),a("p",[e._v("我们在项目根目录中，执行 "),a("code",[e._v("npm run watch")]),e._v("，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ npm run watch\n\n> debug-webpack@1.0.0 watch ~/Test/debug-webpack\n> webpack --watch\n\n\nwebpack is watching the files…\n\nHash: 2e91628041d9a877f709\nVersion: webpack 4.20.2\nTime: 347ms\nBuilt at: 2018-10-25 10:50:27\n   Asset       Size  Chunks             Chunk Names\nindex.js  937 bytes       0  [emitted]  index\nEntrypoint index = index.js\n[0] ./src/index.js 8 bytes {0} [built]\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br")])]),a("p",[e._v("命令执行完之后，并没有退出，"),a("br"),e._v("\n它会监控源码文件，然后只对改变的文件进行重编译。")]),e._v(" "),a("h4",{attrs:{id:"_1-3-修改源代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-修改源代码"}},[e._v("#")]),e._v(" 1.3 修改源代码")]),e._v(" "),a("p",[e._v("我们修改一下src/index.js文件，把内容改成，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("alert(1);\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("然后保存。"),a("br"),e._v("\n我们发现命令行中，在以上输出内容的尾部，又增加了如下信息，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("Hash: 3d9c84dc401a1a18ea6b\nVersion: webpack 4.20.2\nTime: 238ms\nBuilt at: 2018-10-25 10:53:51\n   Asset       Size  Chunks             Chunk Names\nindex.js  938 bytes       0  [emitted]  index\nEntrypoint index = index.js\n[0] ./src/index.js 9 bytes {0} [built]\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br")])]),a("p",[e._v("其中"),a("code",[e._v("Hash")]),e._v("值发生了变化。")]),e._v(" "),a("h3",{attrs:{id:"_2-webpack-watch流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-webpack-watch流程"}},[e._v("#")]),e._v(" 2. webpack watch流程")]),e._v(" "),a("h4",{attrs:{id:"_2-1-回顾compiler-run"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-回顾compiler-run"}},[e._v("#")]),e._v(" 2.1 回顾compiler.run")]),e._v(" "),a("p",[e._v("在"),a("a",{attrs:{href:"https://www.jianshu.com/p/4f6de2d34e29",target:"_blank",rel:"noopener noreferrer"}},[e._v("第三篇"),a("OutboundLink")],1),e._v("文章中，我们知道，"),a("br"),e._v(" "),a("code",[e._v("npm run build")]),e._v("，调用了"),a("code",[e._v("node_modules/.bin/webpack")]),e._v("，它是一个软链接，"),a("br"),e._v("\n原身在 node_modules/_webpack@4.20.2@webpack/bin/webpack.js。")]),e._v(" "),a("p",[e._v("然后 webpack/bin/webpack.js "),a("code",[e._v("require")]),e._v("了 webpack-cli/bin/cli.js，"),a("br"),e._v("\nwebpack-cli中引用了webpack模块，然后调用了"),a("code",[e._v("compiler.run")]),e._v("。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-8c2d5f36c92dd7da.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511/format/webp",alt:""}})]),e._v(" "),a("h4",{attrs:{id:"_2-2-webpack-cli调用compiler-watch"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-webpack-cli调用compiler-watch"}},[e._v("#")]),e._v(" 2.2 webpack-cli调用compiler.watch")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-f1040a80082fb26d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511/format/webp",alt:""}})]),e._v(" "),a("p",[e._v("与"),a("code",[e._v("npm run build")]),e._v("不同是，"),a("code",[e._v("npm run watch")]),e._v("会带参数 "),a("code",[e._v("--watch")]),e._v(" 调用 node_modules/.bin/webpack，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ node_modules/.bin/webpack --watch\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("这样会影响 webpack-cli的代码逻辑，"),a("br"),e._v("\n重新分析 "),a("a",{attrs:{href:"https://github.com/webpack/webpack-cli/blob/v3.1.2/bin/cli.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("webpack-cli/bin/cli.js"),a("OutboundLink")],1),e._v(" ，我们发现在 "),a("a",{attrs:{href:"https://github.com/webpack/webpack-cli/blob/v3.1.2/bin/cli.js#L518",target:"_blank",rel:"noopener noreferrer"}},[e._v("第518行"),a("OutboundLink")],1),e._v("，判断了是否处于"),a("strong",[e._v("watch模式")]),e._v("，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("if (firstOptions.watch || options.watch) {\n    ...\n    compiler.watch(watchOptions, compilerCallback);\n    ...\n} else compiler.run(compilerCallback);\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("p",[e._v("如果处于watch模式，就调用"),a("code",[e._v("compiler.watch")]),e._v("。"),a("br"),e._v("\n通过写log我们得到"),a("code",[e._v("watchOptions")]),e._v("的值为"),a("code",[e._v("true")]),e._v("。")]),e._v(" "),a("h4",{attrs:{id:"_2-3-如何debug"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-如何debug"}},[e._v("#")]),e._v(" 2.3 如何debug")]),e._v(" "),a("p",[a("strong",[e._v("（1）新建debug.js")])]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("const webpack = require('webpack');\nconst options = require('./webpack.config');\n\nconst compiler = webpack(options);\ncompiler.watch(true, (...args) => { });\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("p",[a("strong",[e._v("（2）作为node脚本执行")])]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ node debug.js\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("结果命令行什么也没输出，也没有返回，卡在了那里。")]),e._v(" "),a("p",[a("strong",[e._v("（3）修改源代码")]),a("br"),e._v("\n现在我们修改一下 src/index.js，然后保存，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("alert(2);\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[a("strong",[e._v("（4）检查编译结果")]),a("br"),e._v("\n打开 dist/index.js ，文件内容如下，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t){alert(2)}]);\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("我们看到它已经更新了。")]),e._v(" "),a("p",[a("strong",[e._v("（5）调试")]),a("br"),e._v("\n这说明debug.js是有效的，我们"),a("strong",[e._v("复现")]),e._v("了watch过程，"),a("br"),e._v("\n接下来我们就可以在"),a("code",[e._v("compiler.watch")]),e._v("位置打断点，"),a("br"),e._v("\n跟踪watch代码逻辑了。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-bebafb4ed644b5f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/489/format/webp",alt:""}})]),e._v(" "),a("p",[e._v("进行单步调试，流程跳转到了 "),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compiler.js#L189",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compiler.js 第189行"),a("OutboundLink")],1),e._v(" 的"),a("code",[e._v("watch")]),e._v(" 方法中。")]),e._v(" "),a("h4",{attrs:{id:"_2-4-watch循环"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-watch循环"}},[e._v("#")]),e._v(" 2.4 watch循环")]),e._v(" "),a("p",[a("strong",[e._v("（1）Watching类")])]),e._v(" "),a("p",[a("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-0f9ba24b25b3b2b5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511/format/webp",alt:""}})]),e._v(" "),a("p",[e._v("查看"),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compiler.js#L189",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compiler.js 第189行"),a("OutboundLink")],1),e._v("，"),a("code",[e._v("watch")]),e._v("是"),a("code",[e._v("Compiler")]),e._v("类的一个实例方法，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("watch(watchOptions, handler) {\n    ...\n    return new Watching(this, watchOptions, handler);\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[e._v("其中"),a("code",[e._v("Watching")]),e._v(" 是在 "),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Watching.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("webpack/bin/Watching.js"),a("OutboundLink")],1),e._v(" 中实现的。")]),e._v(" "),a("p",[a("strong",[e._v("（2）compiler.readRecords")])]),e._v(" "),a("p",[a("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-efc543f23a4580cc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511/format/webp",alt:""}})]),e._v(" "),a("p",[a("code",[e._v("Watching")]),e._v("构造函数调用了"),a("code",[e._v("this.compiler.readRecords")]),e._v("，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("class Watching {\n    constructor(compiler, watchOptions, handler) {\n        ...\n        this.compiler.readRecords(err => {\n            ...\n            this._go();\n        });\n    }\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br")])]),a("p",[a("code",[e._v("readRecords")]),e._v("位于"),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compiler.js#L393",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compiler.js 第393行"),a("OutboundLink")],1),e._v("，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("readRecords(callback) {\n    if (!this.recordsInputPath) {\n        ...\n        return callback();\n    }\n    ...\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br")])]),a("p",[e._v("它判断了，"),a("code",[e._v("compiler.recordsInputPath")]),e._v("这个属性，"),a("br"),e._v("\n在我们的例子中，它为"),a("code",[e._v("undefined")]),e._v("，于是直接调用"),a("code",[e._v("callback")]),e._v("返回了。")]),e._v(" "),a("p",[a("code",[e._v("this.compiler.readRecords")]),e._v("返回后，会调用"),a("code",[e._v("this._go();")]),e._v(" 。")]),e._v(" "),a("p",[a("strong",[e._v("（3）watching._go")]),a("br"),e._v(" "),a("code",[e._v("this._go")]),e._v("是"),a("code",[e._v("Watching")]),e._v("类的实例方法，位于"),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Watching.js#L36",target:"_blank",rel:"noopener noreferrer"}},[e._v("Watching.js 第36行"),a("OutboundLink")],1),e._v("，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("_go() {\n    ...\n    this.compiler.hooks.watchRun.callAsync(this.compiler, err => {\n        ...\n        this.compiler.compile(onCompiled);\n    });\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br")])]),a("p",[e._v("它会先调用"),a("code",[e._v("compiler.hooks.watchRun")]),e._v("，然后再调用"),a("code",[e._v("compiler.compile")]),e._v("方法。"),a("br"),e._v(" "),a("code",[e._v("compiler.compile")]),e._v("方法我们已经很熟悉了，它会先make然后在seal。")]),e._v(" "),a("p",[a("strong",[e._v("（4）onCompiled")]),a("br"),e._v(" "),a("code",[e._v("onCompiled")]),e._v("是"),a("code",[e._v("compiler.compile")]),e._v("做完之后的回调，它会处理把文件内容实际写到文件中的逻辑。")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("const onCompiled = (err, compilation) => {\n    ...\n    this.compiler.emitAssets(compilation, err => {\n        ...\n        this.compiler.emitRecords(err => {\n            ...\n            return this._done(null, compilation);\n        });\n    });\n};\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br")])]),a("p",[e._v("最终调用了"),a("code",[e._v("this._done")]),e._v("，它是"),a("code",[e._v("Watching")]),e._v("类的实例方法，位于"),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Watching.js#L88",target:"_blank",rel:"noopener noreferrer"}},[e._v("Watching.js 第88行"),a("OutboundLink")],1),e._v("。")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("_done(err, compilation) {\n    ...\n    this.compiler.hooks.done.callAsync(stats, () => {\n        ...\n        if (!this.closed) {\n            this.watch(\n                ...\n            );\n        }\n        ...\n    });\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br")])]),a("p",[a("code",[e._v("this._done")]),e._v("里面会触发"),a("code",[e._v("compiler.hooks.done")]),e._v("，表示编译完成了，"),a("br"),e._v("\n然后调用"),a("code",[e._v("this.watch")]),e._v("开始监控文件的变更。")]),e._v(" "),a("p",[a("strong",[e._v("（5）循环")])]),e._v(" "),a("p",[a("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-9082a2709bd8153a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511/format/webp",alt:""}})]),e._v(" "),a("p",[a("code",[e._v("this.watch")]),e._v("是"),a("code",[e._v("Watching")]),e._v("类的一个方法，位于"),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Watching.js#L113",target:"_blank",rel:"noopener noreferrer"}},[e._v("Watching.js 第113行"),a("OutboundLink")],1),e._v("，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("watch(files, dirs, missing) {\n    ...\n    this.watcher = this.compiler.watchFileSystem.watch(\n        ...\n        (\n            ...\n        ) => {\n            ...\n            this._invalidate();\n        },\n        (fileName, changeTime) => {\n            this.compiler.hooks.invalid.call(fileName, changeTime);\n        }\n    );\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br")])]),a("p",[e._v("在文件发生变化时，会调用它的最后一个回调，从而触发"),a("code",[e._v("compiler.hooks.invalid")]),e._v("这个hooks。"),a("br"),e._v("\n我们可以拿到发生变更的文件名"),a("code",[e._v("fileName")]),e._v("，和变更时间"),a("code",[e._v("changeTime")]),e._v("。")]),e._v(" "),a("p",[e._v("我们在这里打个断点，然后修改一下src/index.js再保存，会发现程序会跳转到这里，"),a("br"),e._v(" "),a("code",[e._v("fileName")]),e._v("的值为，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("~/Test/debug-webpack/src/index.js\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[a("code",[e._v("changeTime")]),e._v("的值是一个时间戳，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("1540440595000\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("这个hooks执行完之后，程序会跳转到"),a("code",[e._v("this.compiler.watchFileSystem.watch")]),e._v("的第一个回调中，"),a("br"),e._v("\n调用"),a("code",[e._v("this._invalidate();")]),e._v(" ，然后在"),a("code",[e._v("_invalidate")]),e._v("中又调用了"),a("code",[e._v("this._go();")]),e._v(" 对源码进行重编译再写入到文件中，"),a("br"),e._v("\n最后回到"),a("code",[e._v("this._done")]),e._v("，调用"),a("code",[e._v("this.watch")]),e._v("重新监控。")]),e._v(" "),a("p",[a("code",[e._v("_invalidate")]),e._v("方法，位于 "),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Watching.js#L155",target:"_blank",rel:"noopener noreferrer"}},[e._v("Watching.js 第155行"),a("OutboundLink")],1),e._v("，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("_invalidate() {\n    ...\n    if (...) {\n        ...\n    } else {\n        this._go();\n    }\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br")])]),a("h3",{attrs:{id:"_3-watch原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-watch原理"}},[e._v("#")]),e._v(" 3. watch原理")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-6526f0962a98b7b0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511/format/webp",alt:""}})]),e._v(" "),a("h4",{attrs:{id:"_3-1-nodeenvironmentplugin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-nodeenvironmentplugin"}},[e._v("#")]),e._v(" 3.1 NodeEnvironmentPlugin")]),e._v(" "),a("p",[e._v("那么webpack到底是怎样监控文件变更的呢？")]),e._v(" "),a("p",[e._v("在"),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Watching.js#L115",target:"_blank",rel:"noopener noreferrer"}},[e._v("Watching.js 第115行"),a("OutboundLink")],1),e._v("，"),a("code",[e._v("Watching")]),e._v("类的"),a("code",[e._v("watch")]),e._v("方法中调用了，"),a("code",[e._v("this.compiler.watchFileSystem.watch")]),e._v("，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("watch(files, dirs, missing) {\n    ...\n    this.watcher = this.compiler.watchFileSystem.watch(\n        ...\n        (\n           ...\n        ) => {\n            ...\n            this._invalidate();\n        },\n        (fileName, changeTime) => {\n            this.compiler.hooks.invalid.call(fileName, changeTime);\n        }\n    );\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br")])]),a("p",[e._v("然而我们在"),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compiler.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compiler.js"),a("OutboundLink")],1),e._v("中却找不到"),a("code",[e._v("watchFileSystem")]),e._v("的定义。"),a("br"),e._v("\n通过"),a("strong",[e._v("全文搜索")]),e._v("，我们发现"),a("code",[e._v("watchFileSystem")]),e._v("属性，是由"),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/node/NodeEnvironmentPlugin.js#L20",target:"_blank",rel:"noopener noreferrer"}},[e._v("lib/node/NodeEnvironmentPlugin.js"),a("OutboundLink")],1),e._v(" 添加上去的。")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("class NodeEnvironmentPlugin {\n    apply(compiler) {\n        ...\n        compiler.watchFileSystem = new NodeWatchFileSystem(\n            compiler.inputFileSystem\n        );\n        ...\n    }\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br")])]),a("p",[e._v("而"),a("code",[e._v("NodeWatchFileSystem")]),e._v(" 则是由 "),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/node/NodeWatchFileSystem.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("lib/node/NodeWatchFileSystem.js"),a("OutboundLink")],1),e._v("实现的，它的"),a("code",[e._v("watch")]),e._v("方法如下，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('watch(files, dirs, missing, startTime, options, callback, callbackUndelayed) {\n    ...\n    this.watcher = new Watchpack(options);\n\n    if (callbackUndelayed) {\n        this.watcher.once("change", callbackUndelayed);\n    }\n\n    this.watcher.once("aggregated", (changes, removals) => {\n        ...\n        callback(\n            ...\n        );\n    });\n\n    this.watcher.watch(files.concat(missing), dirs.concat(missing), startTime);\n    ...\n}\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br"),a("span",{staticClass:"line-number"},[e._v("17")]),a("br"),a("span",{staticClass:"line-number"},[e._v("18")]),a("br")])]),a("p",[e._v("它实例化了一个"),a("code",[e._v("WatchPack")]),e._v("对象，然后为"),a("code",[e._v("watcher")]),e._v("注册了两个事件监听器，"),a("br"),e._v("\n当"),a("code",[e._v("change")]),e._v("事件发生时，会触发最后一个回调"),a("code",[e._v("callbackUndelayed")]),e._v("，"),a("br"),e._v(" "),a("code",[e._v("aggregated")]),e._v("事件发生时会触发第一个回调"),a("code",[e._v("callback")]),e._v("。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-5620e61b296a5004.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511/format/webp",alt:""}})]),e._v(" "),a("h4",{attrs:{id:"_3-2-watchpack"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-watchpack"}},[e._v("#")]),e._v(" 3.2 WatchPack")]),e._v(" "),a("p",[e._v("其中"),a("code",[e._v("WatchPack")]),e._v("来自一个独立的代码库，它是由模块"),a("a",{attrs:{href:"https://github.com/webpack/watchpack/tree/v1.6.0",target:"_blank",rel:"noopener noreferrer"}},[e._v("watchpack"),a("OutboundLink")],1),e._v("（v1.6.0）导出的，"),a("br"),e._v("\n它可以用来监控文件和目录的变更。")]),e._v(" "),a("p",[a("strong",[e._v("（1）watchPack.watch")]),a("br"),e._v("\n我们来看一下"),a("code",[e._v("WatchPack")]),e._v("的"),a("code",[e._v("watch")]),e._v("方法，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("Watchpack.prototype.watch = function watch(files, directories, startTime) {\n    ...\n    this.fileWatchers = files.map(function(file) {\n        return this._fileWatcher(file, watcherManager.watchFile(file, this.watcherOptions, startTime));\n    }, this);\n    this.dirWatchers = directories.map(function(dir) {\n        return this._dirWatcher(dir, watcherManager.watchDirectory(dir, this.watcherOptions, startTime));\n    }, this);\n    ...\n};\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br")])]),a("p",[e._v("它调用了"),a("code",[e._v("_fileWatcher")]),e._v("或"),a("code",[e._v("_dirWatcher")]),e._v("方法，第一个参数是"),a("code",[e._v("file")]),e._v("或"),a("code",[e._v("dir")]),e._v("，"),a("br"),e._v("\n第二个参数是一个"),a("code",[e._v("watcher")]),e._v("对象，根据"),a("code",[e._v("_fileWatcher")]),e._v("或"),a("code",[e._v("_dirWatcher")]),e._v("方法的形参我们可以确定这一点，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('Watchpack.prototype._fileWatcher = function _fileWatcher(file, watcher) {\n    watcher.on("change", function(mtime, type) {\n        ...\n    }.bind(this));\n    watcher.on("remove", function(type) {\n        ...\n    }.bind(this));\n    return watcher;\n};\n\nWatchpack.prototype._dirWatcher = function _dirWatcher(item, watcher) {\n    watcher.on("change", function(file, mtime, type) {\n        ...\n    }.bind(this));\n    return watcher;\n};\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br")])]),a("p",[e._v("它们只是调用了第二个参数"),a("code",[e._v("watcher")]),e._v("，为之注册了"),a("code",[e._v("change")]),e._v("和"),a("code",[e._v("remove")]),e._v("事件而已。"),a("br"),e._v("\n因此，我们要重点考虑下"),a("code",[e._v("watcher")]),e._v("是怎么来的，"),a("br"),e._v("\n查看"),a("code",[e._v("watch")]),e._v("方法，我们知道，"),a("code",[e._v("watcher")]),e._v("是由"),a("code",[e._v("watcherManager.watchFile")]),e._v("或"),a("code",[e._v("watchDirectory")]),e._v("创建的，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("watcherManager.watchFile(file, this.watcherOptions, startTime)\nwatcherManager.watchDirectory(dir, this.watcherOptions, startTime)\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[a("strong",[e._v("（2）watcherManager.watchDirectory")]),a("br"),e._v(" "),a("code",[e._v("watcherManager.watchFile")]),e._v("和"),a("code",[e._v("watcherManager.watchDirectory")]),e._v("，"),a("br"),e._v("\n定义在"),a("a",{attrs:{href:"https://github.com/webpack/watchpack/blob/v1.6.0/lib/watcherManager.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("watchpack/lib/watchManager.js"),a("OutboundLink")],1),e._v("中，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("WatcherManager.prototype.watchFile = function watchFile(p, options, startTime) {\n    ...\n    return this.getDirectoryWatcher(directory, options).watch(p, startTime);\n};\n\nWatcherManager.prototype.watchDirectory = function watchDirectory(directory, options, startTime) {\n    return this.getDirectoryWatcher(directory, options).watch(directory, startTime);\n};\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br")])]),a("p",[e._v("它们都调用了"),a("code",[e._v("getDirectoryWatcher")]),e._v("。"),a("br"),e._v("\n而 "),a("code",[e._v("getDirectoryWatcher")]),e._v("中则创建了一个"),a("code",[e._v("DirectoryWatcher")]),e._v("对象执行"),a("code",[e._v("watch")]),e._v("操作。"),a("br"),e._v("\n位于 "),a("a",{attrs:{href:"https://github.com/webpack/watchpack/blob/v1.6.0/lib/watcherManager.js#L18",target:"_blank",rel:"noopener noreferrer"}},[e._v("watchpack/lib/watchManager.js 第18行"),a("OutboundLink")],1),e._v("，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("WatcherManager.prototype.getDirectoryWatcher = function(directory, options) {\n    ... \n    if(...) {\n        this.directoryWatchers[key] = new DirectoryWatcher(directory, options);\n        ...\n    }\n    ...\n};\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br")])]),a("p",[a("strong",[e._v("（3）DirectoryWatcher")]),a("br"),e._v(" "),a("code",[e._v("DirectoryWatcher")]),e._v("也是watchpack创建的对象，定义在 "),a("a",{attrs:{href:"https://github.com/webpack/watchpack/blob/v1.6.0/lib/DirectoryWatcher.js#L46",target:"_blank",rel:"noopener noreferrer"}},[e._v("watchpack/lib/DirectoryWatcher.js"),a("OutboundLink")],1),e._v("中，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("function DirectoryWatcher(directoryPath, options) {\n    ...\n    this.watcher = chokidar.watch(directoryPath, {\n        ...\n    });\n    ...\n}\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br")])]),a("p",[e._v("它调用了"),a("a",{attrs:{href:"https://github.com/paulmillr/chokidar/tree/2.0.4",target:"_blank",rel:"noopener noreferrer"}},[e._v("chokidar"),a("OutboundLink")],1),e._v("（v2.0.4）模块得到了一个"),a("code",[e._v("watcher")]),e._v("。"),a("br"),e._v("\nchokidar，封装了Node.js内置的"),a("strong",[e._v("fs.watch")]),e._v("方法，位于"),a("a",{attrs:{href:"https://github.com/paulmillr/chokidar/blob/2.0.4/lib/nodefs-handler.js#L37",target:"_blank",rel:"noopener noreferrer"}},[e._v("chokidar/lib/nodefs-handler.js 第37行"),a("OutboundLink")],1),e._v("，")]),e._v(" "),a("p",[e._v("**")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("return fs.watch(path, options, handleEvent);\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("fs.watch的文档可以参考这里，"),a("a",{attrs:{href:"https://nodejs.org/dist/latest-v8.x/docs/api/fs.html#fs_class_fs_fswatcher",target:"_blank",rel:"noopener noreferrer"}},[e._v("Class: fs.FSWatcher"),a("OutboundLink")],1),e._v("。"),a("br"),e._v("\n总之，watchpack调用了chokidar，chokidar调用了fs.watch完成了watch操作。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-ab4e0b773f57950a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511/format/webp",alt:""}})]),e._v(" "),a("hr"),e._v(" "),a("h3",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[e._v("#")]),e._v(" 参考")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/webpack/webpack-cli/blob/v3.1.2/bin/cli.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("webpack-cli v3.1.2 lib/cli.js"),a("OutboundLink")],1),a("br"),e._v(" "),a("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Watching.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("webpack v4.20.2 bin/Watching.js"),a("OutboundLink")],1),a("br"),e._v(" "),a("a",{attrs:{href:"https://github.com/webpack/watchpack/tree/v1.6.0",target:"_blank",rel:"noopener noreferrer"}},[e._v("watchpack v1.6.0"),a("OutboundLink")],1),a("br"),e._v(" "),a("a",{attrs:{href:"https://github.com/paulmillr/chokidar/tree/2.0.4",target:"_blank",rel:"noopener noreferrer"}},[e._v("chokidar v2.0.4"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=t.exports}}]);