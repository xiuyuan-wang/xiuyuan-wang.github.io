(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{289:function(s,n,e){"use strict";e.r(n);var a=e(14),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h3",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),n("p",[s._v("上篇文章我们分享了关于 "),n("code",[s._v("页面性能监控")]),s._v(" 的内容，本文我们接着来看 "),n("code",[s._v("用户行为监控")]),s._v(" 的方面")]),s._v(" "),n("h3",{attrs:{id:"系列文章传送门"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#系列文章传送门"}},[s._v("#")]),s._v(" 系列文章传送门")]),s._v(" "),n("p",[n("a",{attrs:{href:"https://juejin.cn/post/7097157902862909471",title:"https://juejin.cn/post/7097157902862909471",target:"_blank",rel:"noopener noreferrer"}},[s._v("一文摸清前端监控实践要点（一）性能监控"),n("OutboundLink")],1)]),s._v(" "),n("p",[n("a",{attrs:{href:"https://juejin.cn/post/7098656658649251877",title:"https://juejin.cn/post/7098656658649251877",target:"_blank",rel:"noopener noreferrer"}},[s._v("一文摸清前端监控实践要点（二）行为监控"),n("OutboundLink")],1)]),s._v(" "),n("p",[n("a",{attrs:{href:"https://juejin.cn/post/7100841779854835719/",title:"https://juejin.cn/post/7100841779854835719/",target:"_blank",rel:"noopener noreferrer"}},[s._v("一文摸清前端监控实践要点（三）错误监控"),n("OutboundLink")],1)]),s._v(" "),n("p",[n("a",{attrs:{href:"https://juejin.cn/post/7108660942686126093",title:"https://juejin.cn/post/7108660942686126093",target:"_blank",rel:"noopener noreferrer"}},[s._v("腾讯三面：说说前端监控告警分析平台的架构设计和难点亮点？"),n("OutboundLink")],1)]),s._v(" "),n("h3",{attrs:{id:"用户的行为特征"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用户的行为特征"}},[s._v("#")]),s._v(" 用户的行为特征")]),s._v(" "),n("p",[s._v("为什么要做用户的行为情况监控？其实也就是问："),n("strong",[s._v("采集了用户的行为信息后我们能做什么")]),s._v("，答案其实很简单：")]),s._v(" "),n("ul",[n("li",[s._v("PV、UV量，日同比、周同比等。能清晰的明白流量变化。")]),s._v(" "),n("li",[s._v("用户热点页面、高访问量TOP10")]),s._v(" "),n("li",[s._v("设备、浏览器语言、浏览器、活跃时间段等的用户特征")]),s._v(" "),n("li",[s._v("用户的行为追踪：某个用户，进入了网站后的一系列操作或者跳转行为；")]),s._v(" "),n("li",[s._v("用户自定义埋点上报用户行为：想做一些自定义事件的监听，比如播放某个视频的行为动作。")]),s._v(" "),n("li",[s._v("多语种站点，每个语种的用户量")])]),s._v(" "),n("h4",{attrs:{id:"整体封装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#整体封装"}},[s._v("#")]),s._v(" 整体封装")]),s._v(" "),n("p",[s._v("跟上文一样，这边先附上整体的一个初始化封装;")]),s._v(" "),n("h5",{attrs:{id:"数据暂存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#数据暂存"}},[s._v("#")]),s._v(" 数据暂存")]),s._v(" "),n("p",[s._v("暂存在 store 里的数据跟 "),n("code",[s._v("文一：性能监控")]),s._v(" 基本类似，这里就附一下用户行为所多的参数")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("export enum metricsName {\n  PI = 'page-information',\n  OI = 'origin-information',\n  RCR = 'router-change-record',\n  CBR = 'click-behavior-record',\n  CDR = 'custom-define-record',\n  HT = 'http-record',\n}\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("h5",{attrs:{id:"整体初始化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#整体初始化"}},[s._v("#")]),s._v(" 整体初始化")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("export default class UserVitals {\n  private engineInstance: EngineInstance;\n\n  // 本地暂存数据在 Map 里 （也可以自己用对象来存储）\n  public metrics: UserMetricsStore;\n\n  public breadcrumbs: BehaviorStore;\n\n  public customHandler: Function;\n\n  // 最大行为追踪记录数\n  public maxBehaviorRecords: number;\n\n  // 允许捕获click事件的DOM标签 eg:button div img canvas\n  clickMountList: Array<string>;\n\n  constructor(engineInstance: EngineInstance) {\n    this.engineInstance = engineInstance;\n    this.metrics = new UserMetricsStore();\n    // 限制最大行为追踪记录数为 100，真实场景下需要外部传入自定义;\n    this.maxBehaviorRecords = 100;\n    // 初始化行为追踪记录\n    this.breadcrumbs = new BehaviorStore({ maxBehaviorRecords: this.maxBehaviorRecords });\n    // 初始化 用户自定义 事件捕获\n    this.customHandler = this.initCustomerHandler();\n    // 作为 真实sdk 的时候，需要在初始化时传入与默认值合并;\n    this.clickMountList = ['button'].map((x) => x.toLowerCase());\n    // 重写事件\n    wrHistory();\n    // 初始化页面基本信息\n    this.initPageInfo();\n    // 初始化路由跳转获取\n    this.initRouteChange();\n    // 初始化用户来路信息获取\n    this.initOriginInfo();\n    // 初始化 PV 的获取;\n    this.initPV();\n    // 初始化 click 事件捕获\n    this.initClickHandler(this.clickMountList);\n    // 初始化 Http 请求事件捕获\n    this.initHttpHandler();\n    // 上报策略在后几篇细说\n  }\n\n  // 封装用户行为的上报入口\n  userSendHandler = (data: IMetrics) => {\n    // 进行通知内核实例进行上报;\n  };\n\n  // 补齐 pathname 和 timestamp 参数\n  getExtends = (): { page: string; timestamp: number | string } => {\n    return {\n      page: this.getPageInfo().pathname,\n      timestamp: new Date().getTime(),\n    };\n  };\n\n  // 初始化用户自定义埋点数据的获取上报\n  initCustomerHandler = (): Function => {\n    //... 详情代码在下文\n  };\n\n  // 初始化 PI 页面基本信息的获取以及返回\n  initPageInfo = (): void => {\n    //... 详情代码在下文\n  };\n\n  // 初始化 RCR 路由跳转的获取以及返回\n  initRouteChange = (): void => {\n    //... 详情代码在下文\n  };\n\n  // 初始化 PV 的获取以及返回\n  initPV = (): void => {\n    //... 详情代码在下文\n  };\n\n  // 初始化 OI 用户来路的获取以及返回\n  initOriginInfo = (): void => {\n    //... 详情代码在下文\n  };\n\n  // 初始化 CBR 点击事件的获取和返回\n  initClickHandler = (mountList: Array<string>): void => {\n    //... 详情代码在下文\n  };\n\n  // 初始化 http 请求的数据获取和上报\n  initHttpHandler = (): void => {\n    //... 详情代码在下文\n  };\n}\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br")])]),n("h4",{attrs:{id:"用户的基本信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用户的基本信息"}},[s._v("#")]),s._v(" 用户的基本信息")]),s._v(" "),n("p",[s._v("获取用户一些基本的信息；包括："),n("code",[s._v("当前访问的网页路径")]),s._v("、"),n("code",[s._v("浏览器语种")]),s._v("、"),n("code",[s._v("屏幕大小")]),s._v("、"),n("code",[s._v("等等")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("export interface PageInformation {\n  host: string;\n  hostname: string;\n  href: string;\n  protocol: string;\n  origin: string;\n  port: string;\n  pathname: string;\n  search: string;\n  hash: string;\n  // 网页标题\n  title: string;\n  // 浏览器的语种 (eg:zh) ; 这里截取前两位，有需要也可以不截取\n  language: string;\n  // 用户 userAgent 信息\n  userAgent?: string;\n  // 屏幕宽高 (eg:1920x1080)  屏幕宽高意为整个显示屏的宽高\n  winScreen: string;\n  // 文档宽高 (eg:1388x937)   文档宽高意为当前页面显示的实际宽高（有的同学喜欢半屏显示）\n  docScreen: string;\n}\n\n// 获取 PI 页面基本信息\ngetPageInfo = (): PageInformation => {\n  const { host, hostname, href, protocol, origin, port, pathname, search, hash } = window.location;\n  const { width, height } = window.screen;\n  const { language, userAgent } = navigator;\n\n  return {\n    host,\n    hostname,\n    href,\n    protocol,\n    origin,\n    port,\n    pathname,\n    search,\n    hash,\n    title: document.title,\n    language: language.substr(0, 2),\n    userAgent,\n    winScreen: `${width}x${height}`,\n    docScreen: `${document.documentElement.clientWidth || document.body.clientWidth}x${\n      document.documentElement.clientHeight || document.body.clientHeight\n    }`,\n  };\n};\n\n// 初始化 PI 页面基本信息的获取以及返回\ninitPageInfo = (): void => {\n  const info: PageInformation = this.getPageInfo();\n  const metrics = info as IMetrics;\n  this.metrics.set(metricsName.PI, metrics);\n};\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br")])]),n("h4",{attrs:{id:"用户行为记录栈"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用户行为记录栈"}},[s._v("#")]),s._v(" 用户行为记录栈")]),s._v(" "),n("p",[n("strong",[s._v("有时候，我们需要去获取用户")]),s._v("的一个"),n("code",[s._v("行为追踪记录")]),s._v("（比如说："),n("code",[s._v("出现了一个线上异常，我们要追溯异常如何发生")]),s._v("），这虽然说可能算是错误监控里面的内容，不过数据捕获部分我们就放在这章 "),n("code",[s._v("行为监控")]),s._v(" 里讲，也就是说，用户自从打开我们的网站后，看了什么，点击了什么")]),s._v(" "),n("p",[s._v("一般来说，我们所谈到的用户行为记录栈，"),n("code",[s._v("需要追踪的事件包括以下")]),s._v("：")]),s._v(" "),n("ul",[n("li",[s._v("路由跳转行为")]),s._v(" "),n("li",[s._v("点击行为")]),s._v(" "),n("li",[s._v("ajax 请求行为")]),s._v(" "),n("li",[s._v("用户自定义事件")])]),s._v(" "),n("p",[n("strong",[s._v("捕获上面的四个行为，只需要在上述四个事件的代码中做数据捕获就可以了，我们放下下面的叙述中细细说明")]),s._v("，这里我就贴一下封装 "),n("code",[s._v("用户行为记录栈")]),s._v(" 的代码：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("export interface behaviorRecordsOptions {\n  maxBehaviorRecords: number;\n}\n\nexport interface behaviorStack {\n  name: metricsName;\n  page: string;\n  timestamp: number | string;\n  value: Object;\n}\n\n// 暂存用户的行为记录追踪\nexport default class behaviorStore {\n  // 数组形式的 stack\n  private state: Array<behaviorStack>;\n\n  // 记录的最大数量\n  private maxBehaviorRecords: number;\n\n  // 外部传入 options 初始化，\n  constructor(options: behaviorRecordsOptions) {\n    const { maxBehaviorRecords } = options;\n    this.maxBehaviorRecords = maxBehaviorRecords;\n    this.state = [];\n  }\n\n  // 从底部插入一个元素，且不超过 maxBehaviorRecords 限制数量\n  push(value: behaviorStack) {\n    if (this.length() === this.maxBehaviorRecords) {\n      this.shift();\n    }\n    this.state.push(value);\n  }\n\n  // 从顶部删除一个元素，返回删除的元素\n  shift() {\n    return this.state.shift();\n  }\n\n  length() {\n    return this.state.length;\n  }\n\n  get() {\n    return this.state;\n  }\n\n  clear() {\n    this.state = [];\n  }\n}\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br")])]),n("h4",{attrs:{id:"路由跳转"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#路由跳转"}},[s._v("#")]),s._v(" 路由跳转")]),s._v(" "),n("p",[s._v("一般的路由跳转行为，都是针对于 "),n("code",[s._v("SPA单页应用")]),s._v("的，因为对于非单页应用来说，"),n("code",[s._v("url")]),s._v("跳转都以页面刷新的形式;")]),s._v(" "),n("h5",{attrs:{id:"hash-路由"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#hash-路由"}},[s._v("#")]),s._v(" Hash 路由")]),s._v(" "),n("p",[n("code",[s._v("hash")]),s._v("路由的监听比较简单，大家都知道可以用"),n("code",[s._v("hashchange")]),s._v("来监听，")]),s._v(" "),n("p",[s._v("但是 "),n("code",[s._v("hash")]),s._v(" 变化除了触发 "),n("code",[s._v("hashchange")]),s._v(" ,也会触发 "),n("code",[s._v("popstate")]),s._v(" 事件,而且会先触发 "),n("code",[s._v("popstate")]),s._v(" 事件，我们可以统一监听 "),n("code",[s._v("popstate")])]),s._v(" "),n("h5",{attrs:{id:"history-路由"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#history-路由"}},[s._v("#")]),s._v(" History 路由")]),s._v(" "),n("p",[s._v("接着往下阅读之前，我们先来了解一下，"),n("code",[s._v("html5")]),s._v(" 的 "),n("code",[s._v("History API")]),s._v(" ，它所支持的 "),n("code",[s._v("API")]),s._v(" 有以下五个")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("history.back()")])]),s._v(" "),n("li",[n("code",[s._v("history.go()")])]),s._v(" "),n("li",[n("code",[s._v("history.forward()")])]),s._v(" "),n("li",[n("code",[s._v("history.pushState()")])]),s._v(" "),n("li",[n("code",[s._v("history.replaceState()")])])]),s._v(" "),n("p",[s._v("同时在 "),n("code",[s._v("History API")]),s._v(" 中还有一个 "),n("code",[s._v("事件")]),s._v(" ，该事件为 "),n("code",[s._v("popstate")]),s._v(";它有着以下"),n("strong",[s._v("特点")]),s._v(";")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("History.back()")]),s._v("、"),n("code",[s._v("History.forward()")]),s._v("、"),n("code",[s._v("History.go()")]),s._v("在被"),n("strong",[s._v("调用")]),s._v("时，会触发 "),n("code",[s._v("popstate事件")])]),s._v(" "),n("li",[s._v("但是"),n("code",[s._v("History.pushState()")]),s._v("和"),n("code",[s._v("History.replaceState()")]),s._v("不会触发 "),n("code",[s._v("popstate事件")]),s._v("。")])]),s._v(" "),n("p",[s._v("所以我们需要对 "),n("code",[s._v("replaceState")]),s._v(" 和 "),n("code",[s._v("pushState")]),s._v("，去"),n("strong",[s._v("创建新的全局Event事件")]),s._v("。然后 "),n("code",[s._v("window.addEventListener")]),s._v(" 监听我们加的 "),n("code",[s._v("Event")]),s._v(" 即可")]),s._v(" "),n("h5",{attrs:{id:"封装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#封装"}},[s._v("#")]),s._v(" 封装")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("简单封装一下")]),s._v(" 以适合上文的"),n("code",[s._v("整体封装")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// 派发出新的 Event\nconst wr = (type: keyof History) => {\n  const orig = history[type];\n  return function (this: unknown) {\n    const rv = orig.apply(this, arguments);\n    const e = new Event(type);\n    window.dispatchEvent(e);\n    return rv;\n  };\n};\n\n// 添加 pushState replaceState 事件\nexport const wrHistory = (): void => {\n  history.pushState = wr('pushState');\n  history.replaceState = wr('replaceState');\n};\n\n// 为 pushState 以及 replaceState 方法添加 Event 事件\nexport const proxyHistory = (handler: Function): void => {\n  // 添加对 replaceState 的监听\n  window.addEventListener('replaceState', (e) => handler(e), true);\n  // 添加对 pushState 的监听\n  window.addEventListener('pushState', (e) => handler(e), true);\n};\n\nexport const proxyHash = (handler: Function): void => {\n  // 添加对 hashchange 的监听\n  // hash 变化除了触发 hashchange ,也会触发 popstate 事件,而且会先触发 popstate 事件，我们可以统一监听 popstate\n  // 这里可以考虑是否需要监听 hashchange,或者只监听 hashchange\n  window.addEventListener('hashchange', (e) => handler(e), true);\n  // 添加对 popstate 的监听\n  // 浏览器回退、前进行为触发的 可以自己判断是否要添加监听\n  window.addEventListener('popstate', (e) => handler(e), true);\n};\n\n// 初始化 RCR 路由跳转的获取以及返回\ninitRouteChange = (): void => {\n  const handler = (e: Event) => {\n    // 正常记录\n    const metrics = {\n      // 跳转的方法 eg:replaceState\n      jumpType: e.type,\n      // 创建时间\n      timestamp: new Date().getTime(),\n      // 页面信息\n      pageInfo: this.getPageInfo(),\n    } as IMetrics;\n    // 一般路由跳转的信息不会进行上报，根据业务形态决定；\n    this.metrics.add(metricsName.RCR, metrics);\n    // 行为记录 不需要携带 pageInfo\n    delete metrics.pageInfo;\n    // 记录到行为记录追踪\n    const behavior = {\n      category: metricsName.RCR,\n      data: metrics,\n      ...this.getExtends(),\n    } as behaviorStack;\n    this.breadcrumbs.push(behavior);\n  };\n  proxyHash(handler);\n  // 为 pushState 以及 replaceState 方法添加 Evetn 事件\n  proxyHistory(handler);\n};\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br")])]),n("h4",{attrs:{id:"pv、uv"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pv、uv"}},[s._v("#")]),s._v(" PV、UV")]),s._v(" "),n("p",[s._v("首先我们来了解一下 PV 和 UV 的定义：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("PV")]),s._v(" 是页面访问量")]),s._v(" "),n("li",[n("code",[s._v("UV")]),s._v(" 是24小时内("),n("code",[s._v("00:00-24:00")]),s._v(")访问的独立用户数。")])]),s._v(" "),n("p",[s._v("那么了解了 PV 和 UV 各是什么之后，我们应该如何做才能采集这两个数据指标呢？其实很简单")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("PV")]),s._v(" 只需要在"),n("code",[s._v("用户每次进入页面的时候")]),s._v("，进行上报即可，这里需要注意 "),n("code",[s._v("SPA单页面")]),s._v(" 应用的PV上报需要结合上面的路由跳转进行；")]),s._v(" "),n("li",[n("code",[s._v("UV")]),s._v(" 我们就会转为"),n("code",[s._v("使用服务端进行采集")]),s._v("，当服务端判断到上报的 "),n("code",[s._v("PV所属的IP")]),s._v("结合"),n("code",[s._v("登录信息或者用户标志")]),s._v("，是当天的第一次上报时，就给它记录一次 "),n("code",[s._v("UV")])])]),s._v(" "),n("p",[s._v("那么按照这个逻辑，我们的 "),n("code",[s._v("PV上报代码")]),s._v(" 可以像这样写，"),n("strong",[s._v("简单封装一下")]),s._v("；")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// 初始化 PV 的获取以及返回\ninitPV = (): void => {\n  const handler = () => {\n    const metrics = {\n      // 还有一些标识用户身份的信息，由项目使用方传入，任意拓展 eg:userId\n      // 创建时间\n      timestamp: new Date().getTime(),\n      // 页面信息\n      pageInfo: this.getPageInfo(),\n      // 用户来路\n      originInformation: getOriginInfo(),\n    } as IMetrics;\n    this.userSendHandler(metrics);\n    // 一般来说， PV 可以立即上报\n  };\n  afterLoad(() => {\n    handler();\n  });\n  proxyHash(handler);\n  // 为 pushState 以及 replaceState 方法添加 Evetn 事件\n  proxyHistory(handler);\n};\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("h4",{attrs:{id:"点击事件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#点击事件"}},[s._v("#")]),s._v(" 点击事件")]),s._v(" "),n("p",[n("strong",[s._v("有时，我们获取用户的点击情况是非常有价值的")]),s._v("，"),n("code",[s._v("比如说有以下场景")]),s._v("：")]),s._v(" "),n("ul",[n("li",[s._v("网站的首页有三个推广广告，那么哪一个广告更能够吸引用户的点击？")]),s._v(" "),n("li",[s._v("放在网页上的视频是否有人进行播放？播放量为多少？")]),s._v(" "),n("li",[s._v("......等等等等")])]),s._v(" "),n("p",[s._v("简而言之，我们如果能够捕获到用户的点击行为，是能够得到一些非常具有价值的指标数据的，"),n("code",[s._v("当然我们也不是要获取用户的所有点击")]),s._v("，里面会包含很多的无意义点击行为，我们需要获取的是具有一些指标意义的点击行为，这就"),n("code",[s._v("需要一定的过滤")]),s._v("，过滤可以根据标签、id、class等等进行过滤：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("简单封装一下")]),s._v(" 以适合上文的"),n("code",[s._v("整体封装")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// 初始化 CBR 点击事件的获取和返回\ninitClickHandler = (mountList: Array<string>): void => {\n  const handler = (e: MouseEvent | any) => {\n    // 这里是根据 tagName 进行是否需要捕获事件的依据，可以根据自己的需要，额外判断id\\class等\n    // 先判断浏览器支持 e.path ，从 path 里先取\n    let target = e.path?.find((x: Element) => mountList.includes(x.tagName?.toLowerCase()));\n    // 不支持 path 就再判断 target\n    target = target || (mountList.includes(e.target.tagName?.toLowerCase()) ? e.target : undefined);\n    if (!target) return;\n    const metrics = {\n      tagInfo: {\n        id: target.id,\n        classList: Array.from(target.classList),\n        tagName: target.tagName,\n        text: target.textContent,\n      },\n      // 创建时间\n      timestamp: new Date().getTime(),\n      // 页面信息\n      pageInfo: this.getPageInfo(),\n    } as IMetrics;\n    // 除开商城业务外，一般不会特意上报点击行为的数据，都是作为辅助检查错误的数据存在;\n    this.metrics.add(metricsName.CBR, metrics);\n    // 行为记录 不需要携带 完整的pageInfo\n    delete metrics.pageInfo;\n    // 记录到行为记录追踪\n    const behavior = {\n      category: metricsName.CBR,\n      data: metrics,\n      ...this.getExtends(),\n    } as behaviorStack;\n    this.breadcrumbs.push(behavior);\n  };\n  window.addEventListener(\n    'click',\n    (e) => {\n      handler(e);\n    },\n    true,\n  );\n};\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br")])]),n("blockquote",[n("p",[s._v("同理，如果我们想捕获 "),n("code",[s._v("input")]),s._v("、"),n("code",[s._v("keydown")]),s._v("、"),n("code",[s._v("doubleClick")]),s._v(" 也是类似的写法，有兴趣的可以自行拓展")])]),s._v(" "),n("h4",{attrs:{id:"用户自定义埋点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用户自定义埋点"}},[s._v("#")]),s._v(" 用户自定义埋点")]),s._v(" "),n("p",[s._v("其实用户自定义埋点这个东西，并没有那么神秘和复杂，原理也就是 SDK 内部暴露出接口供 "),n("code",[s._v("项目使用方")]),s._v(" 调用，这样用户就可以"),n("code",[s._v("在任意的时间段")]),s._v("（"),n("code",[s._v("页面加载")]),s._v("、"),n("code",[s._v("用户点击")]),s._v("、"),n("code",[s._v("观看视频达到一半进度")]),s._v("....等等）去调用接口 "),n("code",[s._v("上报任意的自定义内容")]),s._v("；")]),s._v(" "),n("p",[s._v("而我们 SDK 暴露出的接口，可以由SDK挂载在 "),n("code",[s._v("window")]),s._v(" 上，也可以通过暴露接口的方式给外部调用；")]),s._v(" "),n("p",[s._v("然后在服务端再进行"),n("code",[s._v("数据的归类分析")]),s._v("，就"),n("strong",[s._v("完成了用户自定义埋点的一系列流程")]),s._v("；实现起来很简单，但是重要的是什么呢？是数据结构的定义，定义的数据结构需要能让服务端方便进行归类分析；")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// 这里参考了 谷歌GA 的自定义埋点上报数据维度结构\nexport interface customAnalyticsData {\n  // 事件类别 互动的对象 eg:Video\n  eventCategory: string;\n  // 事件动作 互动动作方式 eg:play\n  eventAction: string;\n  // 事件标签 对事件进行分类 eg:\n  eventLabel: string;\n  // 事件值 与事件相关的数值   eg:180min\n  eventValue?: string;\n}\n\n// 初始化用户自定义埋点数据的获取上报\ninitCustomerHandler = (): Function => {\n  const handler = (options: customAnalyticsData) => {\n    // 记录到 UserMetricsStore\n    this.metrics.add(metricsName.CDR, options);\n    // 自定义埋点的信息一般立即上报\n    this.userSendHandler(options);\n    // 记录到用户行为记录栈\n    this.breadcrumbs.push({\n      category: metricsName.CDR,\n      data: options,\n      ...this.getExtends(),\n    });\n  };\n\n  return handler;\n};\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("h4",{attrs:{id:"http-请求捕获"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#http-请求捕获"}},[s._v("#")]),s._v(" HTTP 请求捕获")]),s._v(" "),n("p",[n("code",[s._v("HTTP行为")]),s._v(" 也是"),n("code",[s._v("用户行为追踪")]),s._v("的重要一环，有的时候，页面出现问题往往是 HTTP 请求了某些数据，渲染造成的；而除了是"),n("code",[s._v("用户行为追踪")]),s._v("的重要一环外；采集 "),n("code",[s._v("HTTP请求")]),s._v(" 的各种信息：包括 "),n("code",[s._v("请求地址")]),s._v("、"),n("code",[s._v("方法")]),s._v("、"),n("code",[s._v("耗时")]),s._v("、"),n("code",[s._v("请求时间")]),s._v("、"),n("code",[s._v("响应时间")]),s._v("、"),n("code",[s._v("响应结果")]),s._v("等等等等...")]),s._v(" "),n("p",[s._v("而为了实现上述的监控需求，我们需要了解到：现在异步请求的底层原理都是调用的 "),n("code",[s._v("XMLHttpRequest")]),s._v(" 或者 "),n("code",[s._v("Fetch")]),s._v("，我们只需要对这两个方法都进行 "),n("code",[s._v("劫持")]),s._v(" ，就可以往接口请求的过程中加入我们所需要的一些参数捕获；")]),s._v(" "),n("h5",{attrs:{id:"xmlhttprequest-的劫持"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#xmlhttprequest-的劫持"}},[s._v("#")]),s._v(" XMLHttpRequest 的劫持")]),s._v(" "),n("p",[s._v("预期就是，我们只需要传入一个 "),n("code",[s._v("loadHandler")]),s._v(" 方法，它就自动会在 "),n("code",[s._v("请求")]),s._v(" 结束时给我返回该有的数据")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("export interface httpMetrics {\n  method: string;\n  url: string | URL;\n  body: Document | XMLHttpRequestBodyInit | null | undefined | ReadableStream;\n  requestTime: number;\n  responseTime: number;\n  status: number;\n  statusText: string;\n  response?: any;\n}\n\n// 调用 proxyXmlHttp 即可完成全局监听 XMLHttpRequest\nexport const proxyXmlHttp = (sendHandler: Function | null | undefined, loadHandler: Function) => {\n  if ('XMLHttpRequest' in window && typeof window.XMLHttpRequest === 'function') {\n    const oXMLHttpRequest = window.XMLHttpRequest;\n    if (!(window as any).oXMLHttpRequest) {\n      // oXMLHttpRequest 为原生的 XMLHttpRequest，可以用以 SDK 进行数据上报，区分业务\n      (window as any).oXMLHttpRequest = oXMLHttpRequest;\n    }\n    (window as any).XMLHttpRequest = function () {\n      // 覆写 window.XMLHttpRequest\n      const xhr = new oXMLHttpRequest();\n      const { open, send } = xhr;\n      let metrics = {} as httpMetrics;\n      xhr.open = (method, url) => {\n        metrics.method = method;\n        metrics.url = url;\n        open.call(xhr, method, url, true);\n      };\n      xhr.send = (body) => {\n        metrics.body = body || '';\n        metrics.requestTime = new Date().getTime();\n        // sendHandler 可以在发送 Ajax 请求之前，挂载一些信息，比如 header 请求头\n        // setRequestHeader 设置请求header，用来传输关键参数等\n        // xhr.setRequestHeader('xxx-id', 'VQVE-QEBQ');\n        if (typeof sendHandler === 'function') sendHandler(xhr);\n        send.call(xhr, body);\n      };\n      xhr.addEventListener('loadend', () => {\n        const { status, statusText, response } = xhr;\n        metrics = {\n          ...metrics,\n          status,\n          statusText,\n          response,\n          responseTime: new Date().getTime(),\n        };\n        if (typeof loadHandler === 'function') loadHandler(metrics);\n        // xhr.status 状态码\n      });\n      return xhr;\n    };\n  }\n};\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br")])]),n("h5",{attrs:{id:"fetch-的劫持"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#fetch-的劫持"}},[s._v("#")]),s._v(" Fetch 的劫持")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// 调用 proxyFetch 即可完成全局监听 fetch\nexport const proxyFetch = (sendHandler: Function | null | undefined, loadHandler: Function) => {\n  if ('fetch' in window && typeof window.fetch === 'function') {\n    const oFetch = window.fetch;\n    if (!(window as any).oFetch) {\n      (window as any).oFetch = oFetch;\n    }\n    (window as any).fetch = async (input: any, init: RequestInit) => {\n      // init 是用户手动传入的 fetch 请求互数据，包括了 method、body、headers，要做统一拦截数据修改，直接改init即可\n      if (typeof sendHandler === 'function') sendHandler(init);\n      let metrics = {} as httpMetrics;\n\n      metrics.method = init?.method || '';\n      metrics.url = (input && typeof input !== 'string' ? input?.url : input) || ''; // 请求的url\n      metrics.body = init?.body || '';\n      metrics.requestTime = new Date().getTime();\n\n      return oFetch.call(window, input, init).then(async (response) => {\n        // clone 出一个新的 response,再用其做.text(),避免 body stream already read 问题\n        const res = response.clone();\n        metrics = {\n          ...metrics,\n          status: res.status,\n          statusText: res.statusText,\n          response: await res.text(),\n          responseTime: new Date().getTime(),\n        };\n        if (typeof loadHandler === 'function') loadHandler(metrics);\n        return response;\n      });\n    };\n  }\n};\n\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("h5",{attrs:{id:"简单初始化封装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#简单初始化封装"}},[s._v("#")]),s._v(" 简单初始化封装")]),s._v(" "),n("p",[s._v("上面都是 proxy 劫持接口的封装，具体的调用看如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// 初始化 http 请求的数据获取和上报\ninitHttpHandler = (): void => {\n  const loadHandler = (metrics: httpMetrics) => {\n    if (metrics.status < 400) {\n      // 对于正常请求的 HTTP 请求来说,不需要记录 请求体 和 响应体\n      delete metrics.response;\n      delete metrics.body;\n    }\n    // 记录到 UserMetricsStore\n    this.metrics.add(metricsName.HT, metrics);\n    // 记录到用户行为记录栈\n    this.breadcrumbs.push({\n      category: metricsName.HT,\n      data: metrics,\n      ...this.getExtends(),\n    });\n  };\n  proxyXmlHttp(null, loadHandler);\n  proxyFetch(null, loadHandler);\n};\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("h4",{attrs:{id:"页面停留时间"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#页面停留时间"}},[s._v("#")]),s._v(" 页面停留时间")]),s._v(" "),n("p",[s._v("还有一项比较通用的指标，叫做页面停留时间，是通过统计用户在每个页面的停留时间而成的")]),s._v(" "),n("p",[s._v("这里给一个"),n("code",[s._v("简单的采集实例代码思路")]),s._v(" "),n("strong",[s._v("（未封装）")]),s._v(" ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const routeList = [];\nconst routeTemplate = {\n  userId: '', // 用户信息等\n  // 除了userId以外，还可以附带一些其余的用户特征到这里面\n  url: '',\n  startTime: 0,\n  dulation: 0,\n  endTime: 0,\n};\nfunction recordNextPage() {\n  // 记录前一个页面的页面停留时间\n  const time = new Date().getTime();\n  routeList[routeList.length - 1].endTime = time;\n  routeList[routeList.length - 1].dulation = time - routeList[routeList.length - 1].startTime;\n  // 推一个新的页面停留记录\n  routeList.push({\n    ...routeTemplate,\n    ...{ url: window.location.pathname, startTime: time, dulation: 0, endTime: 0 },\n  });\n}\n// 第一次进入页面时,记录\nwindow.addEventListener('load', () => {\n  const time = new Date().getTime();\n  routeList.push({\n    ...routeTemplate,\n    ...{ url: window.location.pathname, startTime: time, dulation: 0, endTime: 0 },\n  });\n});\n// 单页面应用触发 replaceState 时的上报\nwindow.addEventListener('replaceState', () => {\n  recordNextPage();\n});\n// 单页面应用触发 pushState 时的上报\nwindow.addEventListener('pushState', () => {\n  recordNextPage();\n});\n// 浏览器回退、前进行为触发的 可以自己判断是否要上报\nwindow.addEventListener('popstate', () => {\n  recordNextPage();\n});\n// 关闭浏览器前记录最后的时间并上报\nwindow.addEventListener('beforeunload', () => {\n  const time = new Date().getTime();\n  routeList[routeList.length - 1].endTime = time;\n  routeList[routeList.length - 1].dulation = time - routeList[routeList.length - 1].startTime;\n  // 记录完了离开的时间，就可以上报了\n  // eg: report()\n});\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br")])]),n("h4",{attrs:{id:"访客来路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#访客来路"}},[s._v("#")]),s._v(" 访客来路")]),s._v(" "),n("p",[s._v("有的时候，产品可能会问我们几个"),n("code",[s._v("直击灵魂的问题")]),s._v("：")]),s._v(" "),n("ul",[n("li",[s._v("我们现在的"),n("strong",[s._v("新用户流量")]),s._v("，大部分都是从哪里引流过来的啊？")]),s._v(" "),n("li",[n("strong",[s._v("线上环境404页面访问激增")]),s._v("，我想知道用户是访问了哪个不存在页面才跳到 404 的")])]),s._v(" "),n("p",[s._v("很简单，采集一下"),n("code",[s._v("用户来路")]),s._v("的数据就可以了，原理就是获取 "),n("code",[s._v("document.referrer")]),s._v(" 以及"),n("code",[s._v("window.performance.navigation.type")])]),s._v(" "),n("h5",{attrs:{id:"用户来路地址"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用户来路地址"}},[s._v("#")]),s._v(" 用户来路地址")]),s._v(" "),n("p",[s._v("我们可以直接用 "),n("code",[s._v("document.referrer")]),s._v(" 来获取用户在我们的网页上的"),n("strong",[s._v("前一个网页地址")]),s._v("；但是需要注意的是，有几个场景我们"),n("code",[s._v("获取到的值会是空")])]),s._v(" "),n("ul",[n("li",[s._v("直接在地址栏中输入地址跳转")]),s._v(" "),n("li",[s._v("直接通过浏览器收藏夹打开")]),s._v(" "),n("li",[s._v("从https的网站直接进入一个http协议的网站")])]),s._v(" "),n("h5",{attrs:{id:"用户来路方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用户来路方式"}},[s._v("#")]),s._v(" 用户来路方式")]),s._v(" "),n("p",[s._v("我们可以直接使用 "),n("code",[s._v("window.performance.navigation.type")]),s._v(" 来获取用户在我们网页上的"),n("strong",[s._v("来路方式")])]),s._v(" "),n("p",[n("strong",[s._v("该属性返回一个整数值，可能有以下4种情况")])]),s._v(" "),n("ul",[n("li",[n("code",[s._v("0")]),s._v(": 点击链接、地址栏输入、表单提交、脚本操作等。")]),s._v(" "),n("li",[n("code",[s._v("1")]),s._v(": 点击重新加载按钮、location.reload。")]),s._v(" "),n("li",[n("code",[s._v("2")]),s._v(": 点击前进或后退按钮。")]),s._v(" "),n("li",[n("code",[s._v("255")]),s._v(": 任何其他来源。即非刷新/非前进后退、非点击链接/地址栏输入/表单提交/脚本操作等。")])]),s._v(" "),n("h5",{attrs:{id:"代码封装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#代码封装"}},[s._v("#")]),s._v(" 代码封装")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("export interface OriginInformation {\n  referrer: string;\n  type: number | string;\n}\n\n// 返回 OI 用户来路信息\nexport const getOriginInfo = (): OriginInformation => {\n  return {\n    referrer: document.referrer,\n    type: window.performance?.navigation.type || '',\n  };\n};\n\n// 初始化 OI 用户来路的获取以及返回\ninitOriginInfo = (): void => {\n  const info: OriginInformation = getOriginInfo();\n  const metrics = info as IMetrics;\n  this.metrics.set(metricsName.OI, metrics);\n};\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("h4",{attrs:{id:"user-agent-解析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#user-agent-解析"}},[s._v("#")]),s._v(" User Agent 解析")]),s._v(" "),n("p",[s._v("我们的 "),n("code",[s._v("User Agent")]),s._v(" 信息里面有带有很多的信息，"),n("code",[s._v("比如浏览器内核")]),s._v("、"),n("code",[s._v("设备类型等等")]),s._v("，但是解析它并不是个简单的事情，如果我们自己写的话，会用到很多的正则表达式去解析它，所以这边推荐"),n("code",[s._v("两个现成的插件")]),s._v("来使用："),n("a",{attrs:{href:"https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flancedikson%2Fbowser",title:"https://github.com/lancedikson/bowser",target:"_blank",rel:"noopener noreferrer"}},[s._v("bowser"),n("OutboundLink")],1),s._v(" 和 "),n("a",{attrs:{href:"https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffaisalman%2Fua-parser-js",title:"https://github.com/faisalman/ua-parser-js",target:"_blank",rel:"noopener noreferrer"}},[s._v("ua-parser-js"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// nodejs 环境下 require\nconst parser = require('ua-parser-js');\nconst Bowser = require('bowser');\n// 获取user-agent解析\nfunction getFeature(userAgent) {\n  const browserData = Bowser.parse(userAgent);\n  const parserData = parser(userAgent);\n  const browserName = browserData.browser.name || parserData.browser.name; // 浏览器名\n  const browserVersion = browserData.browser.version || parserData.browser.version; // 浏览器版本号\n  const osName = browserData.os.name || parserData.os.name; // 操作系统名\n  const osVersion = parserData.os.version || browserData.os.version; // 操作系统版本号\n  const deviceType = browserData.platform.type || parserData.device.type; // 设备类型\n  const deviceVendor = browserData.platform.vendor || parserData.device.vendor || ''; // 设备所属公司\n  const deviceModel = browserData.platform.model || parserData.device.model || ''; // 设备型号\n  const engineName = browserData.engine.name || parserData.engine.name; // engine名\n  const engineVersion = browserData.engine.version || parserData.engine.version; // engine版本号\n  return {\n    browserName,\n    browserVersion,\n    osName,\n    osVersion,\n    deviceType,\n    deviceVendor,\n    deviceModel,\n    engineName,\n    engineVersion,\n  };\n}\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("h4",{attrs:{id:"ip-采集解析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ip-采集解析"}},[s._v("#")]),s._v(" IP 采集解析")]),s._v(" "),n("p",[s._v("为什么要采集 IP 呢？其实很简单，我们可以通过解析 IP 地址，来解析出用户的"),n("code",[s._v("地域")]),s._v("、"),n("code",[s._v("网络运营商等信息")]),s._v("；而"),n("code",[s._v("解析IP")]),s._v("我们可以使用诸如腾讯云、阿里云等各种的 "),n("code",[s._v("三方API")]),s._v(" 来实现；但是"),n("code",[s._v("采集 IP 信息")]),s._v("就需要我们自己来进行实现了；")]),s._v(" "),n("p",[s._v("具体来说，"),n("code",[s._v("IP")]),s._v(" 并不是一个通过 "),n("code",[s._v("JS SDK")]),s._v(" 来采集的"),n("strong",[s._v("指标数据")]),s._v("，我们需要在服务端去获取访问过来的IP地址，"),n("code",[s._v("获取 IP 地址的方法")]),s._v("我建议先阅读一下这篇文章： "),n("a",{attrs:{href:"https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fw3cnote%2Fhttp-x-forwarded-for.html",title:"https://www.runoob.com/w3cnote/http-x-forwarded-for.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("HTTP X-Forwarded-For 介绍 | 菜鸟教程"),n("OutboundLink")],1)]),s._v(" "),n("p",[n("strong",[s._v("直接贴结论")]),s._v("：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("对于直接面向用户部署的 Web 应用")]),s._v("，"),n("code",[s._v("必须使用")]),s._v("从 TCP 连接中得到的 "),n("code",[s._v("Remote Address")]),s._v("；")]),s._v(" "),n("li",[n("strong",[s._v("对于部署了 Nginx 这样反向代理的 Web 应用")]),s._v("，可以使用 Nginx 传过来的 "),n("code",[s._v("X-Real-IP")]),s._v(" 或 "),n("code",[s._v("X-Forwarded-For 最后一节")]),s._v("（实际上它们一定等价）。")])]),s._v(" "),n("p",[n("strong",[s._v("我这边举例一下 Nginx 下的获取，这里取 "),n("code",[s._v("x-real-ip")]),s._v(" 或 "),n("code",[s._v("x-forwarded-for")]),s._v(" 的最后一节即可")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// nodejs 代码\nconst http = require('http');\n\nfunction getIp(req) {\n  const ip = (req.headers['x-forwarded-for'] || req.connection.remoteAddress).replace('::ffff:', '');\n  // 取 x-forwarded-for 的话再做一个取最后一节的处理\n  return ip === '::1' ? '127.0.0.1' : ip;\n}\nhttp\n  .createServer((req, res) => {\n    res.writeHead(200, { 'Content-Type': 'text/plain' });\n    // 先取x-real-ip\n    // 再取service里的自定义方法，取x-forwarded-for最后一节\n    const ip = req.headers['x-real-ip'] || getIp(req);\n    res.write(`ip: ${ip}\\n`);\n    res.end();\n  })\n  .listen(9009, '0.0.0.0');\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("h4",{attrs:{id:"参考链接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),n("p",[n("a",{attrs:{href:"https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fw3cnote%2Fhttp-x-forwarded-for.html",title:"https://www.runoob.com/w3cnote/http-x-forwarded-for.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("HTTP X-Forwarded-For 介绍 | 菜鸟教程"),n("OutboundLink")],1)])])}),[],!1,null,null,null);n.default=t.exports}}]);