(window.webpackJsonp=window.webpackJsonp||[]).push([[113],{295:function(e,s,n){"use strict";n.r(s);var a=n(14),t=Object(a.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h3",{attrs:{id:"_1-精彩回顾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-精彩回顾"}},[e._v("#")]),e._v(" 1. 精彩回顾")]),e._v(" "),s("h4",{attrs:{id:"_1-1-历史篇章"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-历史篇章"}},[e._v("#")]),e._v(" 1.1 历史篇章")]),e._v(" "),s("p",[e._v("本系列文章已经进展到了第六篇，")]),e._v(" "),s("p",[e._v("在"),s("a",{attrs:{href:"https://www.jianshu.com/p/de262ad255c3",target:"_blank",rel:"noopener noreferrer"}},[e._v("第一篇"),s("OutboundLink")],1),e._v("中，我们介绍了一个小游戏，游戏的主角"),s("strong",[e._v("穿越")]),e._v("到了游戏中，"),s("br"),e._v("\n只有集齐金庸的14天书，才能回到现实世界中。"),s("br"),e._v("\n这非常类似于我们学习webpack源码的过程，不同的是，我们穿越到了"),s("strong",[e._v("代码世界")]),e._v("中。")]),e._v(" "),s("p",[s("a",{attrs:{href:"https://www.jianshu.com/p/2fa6562210ef",target:"_blank",rel:"noopener noreferrer"}},[e._v("第二篇"),s("OutboundLink")],1),e._v("我们做了一些准备工作，先用nvm管理Node.js版本，"),s("br"),e._v("\n然后创建了一个称为"),s("a",{attrs:{href:"https://www.jianshu.com/p/2fa6562210ef",target:"_blank",rel:"noopener noreferrer"}},[e._v("debug-webpack"),s("OutboundLink")],1),e._v("的示例应用，"),s("br"),e._v("\n以此为入口，打开了"),s("strong",[e._v("webpack世界")]),e._v("的大门。")]),e._v(" "),s("p",[e._v("为了跟踪程序的执行过程，"),s("a",{attrs:{href:"https://www.jianshu.com/p/4f6de2d34e29",target:"_blank",rel:"noopener noreferrer"}},[e._v("第三篇"),s("OutboundLink")],1),e._v("中我介绍了自己常用的两个方法，"),s("br"),e._v("\n一个是"),s("strong",[e._v("写log")]),e._v("，另一个是使用vscode对程序进行"),s("strong",[e._v("调试")]),e._v("。"),s("br"),e._v("\n在这一篇中，我们还简要分析了webpack命令行工具，和webpack-cli的代码逻辑。")]),e._v(" "),s("p",[e._v("接下来的"),s("a",{attrs:{href:"https://www.jianshu.com/p/3ae8522fb098",target:"_blank",rel:"noopener noreferrer"}},[e._v("第四篇"),s("OutboundLink")],1),e._v("，是"),s("strong",[e._v("非常烧脑")]),e._v("的一篇，"),s("br"),e._v("\n在这篇中，我们理清了完整的"),s("strong",[e._v("资源加载过程")]),e._v("。"),s("br"),e._v("\nwebpack会递归的加载每个入口文件loader，然后再用loader加载文件。"),s("br"),e._v("\n我们的示例中，涉及了webpack，loader-runner和babel-loader。")]),e._v(" "),s("p",[s("a",{attrs:{href:"https://www.jianshu.com/p/3212f5b40a50",target:"_blank",rel:"noopener noreferrer"}},[e._v("第五篇"),s("OutboundLink")],1),e._v("，我们介绍了"),s("strong",[e._v("hooks")]),e._v("的原理，"),s("br"),e._v("\nwebpack使用一个名为"),s("strong",[e._v("tapable")]),e._v("的代码库，实现了强大的"),s("strong",[e._v("切面")]),e._v("功能，"),s("br"),e._v("\n我们可以编写"),s("strong",[e._v("插件")]),e._v("，利用webpack预留的各个切面进行编程。")]),e._v(" "),s("p",[e._v("到目前为止，我们已经对webpack资源加载和webpack hooks，有了一定的了解了，"),s("br"),e._v("\n所以从本文开始，让我们继续往下进行吧。")]),e._v(" "),s("p",[e._v("看看加载的这些文件，是怎样生成最终代码的，"),s("br"),e._v("\n这有点类似于通常的"),s("strong",[e._v("编译器优化")]),e._v("和"),s("strong",[e._v("后端")]),e._v("做的事情。")]),e._v(" "),s("p",[e._v("在此之前，我们再回顾一下debug-webpack和debug.js")]),e._v(" "),s("h4",{attrs:{id:"_1-2-debug-webpack示例应用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-debug-webpack示例应用"}},[e._v("#")]),e._v(" 1.2 debug-webpack示例应用")]),e._v(" "),s("p",[e._v("还记得我们的"),s("a",{attrs:{href:"https://www.jianshu.com/p/2fa6562210ef",target:"_blank",rel:"noopener noreferrer"}},[e._v("debug-webpack"),s("OutboundLink")],1),e._v("示例应用么？"),s("br"),e._v("\n这是第二篇中我们创建的一个小项目，简单配置了一下webpack.config.js。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("const path = require('path');\nconst fs = require('fs');\n\nmodule.exports = {\n    entry: {\n        index: path.resolve(__dirname, 'src/index.js'),\n    },\n    output: {\n        path: path.resolve(__dirname, 'dist/'),\n    },\n    module: {\n        rules: [\n            { test: /.js$/, use: { loader: 'babel-loader', query: { presets: ['@babel/preset-env'] } } },\n        ]\n    }\n};\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br")])]),s("p",[e._v("没有使用任何插件，只是指定了"),s("code",[e._v("entry")]),e._v("为 ./src/index.js，"),s("br"),e._v("\n然后借助babel-loader加载它，最后将目标代码生成到 ./dist/ 中。")]),e._v(" "),s("h4",{attrs:{id:"_1-3-debug-js"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-debug-js"}},[e._v("#")]),e._v(" 1.3 debug.js")]),e._v(" "),s("p",[e._v("再来看看为了调试webpack，我们在"),s("a",{attrs:{href:"https://www.jianshu.com/p/4f6de2d34e29",target:"_blank",rel:"noopener noreferrer"}},[e._v("第三篇"),s("OutboundLink")],1),e._v("中新建的 ./debug.js 吧，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("const webpack = require('webpack');\nconst options = require('./webpack.config');\n\nconst compiler = webpack(options);\n\ncompiler.run((...args) => {\n    console.log(args);\n});\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("p",[e._v("还记得么，根据第三篇介绍的方法，我们将程序停在了断点处。")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-9d896a28e4b5f56a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/531/format/webp",alt:""}})]),e._v(" "),s("h4",{attrs:{id:"_1-4-资源加载过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-资源加载过程"}},[e._v("#")]),e._v(" 1.4 资源加载过程")]),e._v(" "),s("p",[e._v("详细的资源加载过程，我们已经在"),s("a",{attrs:{href:"https://www.jianshu.com/p/3ae8522fb098",target:"_blank",rel:"noopener noreferrer"}},[e._v("第四篇"),s("OutboundLink")],1),e._v("中介绍了，"),s("br"),e._v("\n这里我们来简单概括下，一图胜千言，")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-053857050655d733.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/557/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("（1）"),s("code",[e._v("compiler.run")]),e._v("方法在 "),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compiler.js#L268",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compiler.js 第268行"),s("OutboundLink")],1),e._v(" 调用了"),s("code",[e._v("compiler.compile")])]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-1e14bbc429d612f4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/264/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("run(callback) {\n    ...\n    this.hooks.beforeRun.callAsync(this, err => {\n        ...\n        this.hooks.run.callAsync(this, err => {\n            ...\n            this.readRecords(err => {\n                ...\n                this.compile(onCompiled);\n            });\n        });\n    });\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br")])]),s("p",[e._v("（2）"),s("code",[e._v("compiler.compile")]),e._v(" 在"),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compiler.js#L536",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compiler.js 第536行"),s("OutboundLink")],1),e._v(" 调用了"),s("code",[e._v("compiler.hooks.make")])]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-5f813af41ac904e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/271/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("compile(callback) {\n    ...\n    this.hooks.beforeCompile.callAsync(params, err => {\n        ...\n        this.hooks.make.callAsync(compilation, err => {\n            ...\n        });\n    });\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br")])]),s("p",[e._v("（3）"),s("code",[e._v("compiler.hooks.make")]),e._v("是在 "),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/SingleEntryPlugin.js#L40",target:"_blank",rel:"noopener noreferrer"}},[e._v("SingleEntryPlugin.js 第40行"),s("OutboundLink")],1),e._v(" 实现的，它调用了"),s("code",[e._v("compilation.addEntry")]),s("br"),e._v("\n并且，将"),s("code",[e._v("compiler.hooks.make")]),e._v("的"),s("code",[e._v("callback")]),e._v("传递给了"),s("code",[e._v("compilation.addEntry")])]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-4ebf32a3036dd4b5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/557/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('compiler.hooks.make.tapAsync(\n    "SingleEntryPlugin",\n    (compilation, callback) => {\n        ...\n        compilation.addEntry(context, dep, name, callback);\n    }\n);\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("p",[e._v("（4）"),s("code",[e._v("compilation.addEntry")]),e._v(" 位于 "),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L1027",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compilation.js 第1027行"),s("OutboundLink")],1),e._v("，它调用了"),s("code",[e._v("compilation._addModuleChain")]),s("br"),e._v("\n完了之后回调到"),s("code",[e._v("compiler.hooks.make")])]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-ba5c7a3d0a12d2e5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/557/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("addEntry(context, entry, name, callback) {\n    ...\n    this._addModuleChain(\n        ...,\n        (err, module) => {\n            ...\n            return callback(null, module);\n        }\n    );\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br")])]),s("p",[e._v("（5）"),s("code",[e._v("compilation._addModuleChain")]),e._v("在 "),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L943",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compilation.js 第943行"),s("OutboundLink")],1),e._v(" 调用了 "),s("code",[e._v("moduleFactory.create")]),s("br"),e._v("\n然后调用"),s("code",[e._v("compilation.buildModule")]),e._v("进行构建，"),s("code",[e._v("buildModule")]),e._v("完了之后，调用了"),s("code",[e._v("afterBuild")]),e._v("，"),s("br"),e._v(" "),s("code",[e._v("afterBuild")]),e._v("调用"),s("code",[e._v("compilation.processModuleDependencies")]),e._v("处理模块的依赖，最后回调"),s("code",[e._v("callback")]),e._v("。")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-5b416161de0c774e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/557/format/webp",alt:""}})]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("_addModuleChain(context, dependency, onModule, callback) {\n    ...\n    this.semaphore.acquire(() => {\n        moduleFactory.create(\n            ...,\n            (err, module) => {\n                ...\n                const afterBuild = () => {\n                    ...\n                    if (addModuleResult.dependencies) {\n                        this.processModuleDependencies(module, err => {\n                            ...\n                            callback(null, module);\n                        });\n                    } else {\n                        return callback(null, module);\n                    }\n                };\n                ...\n                this.buildModule(module, false, null, null, err => {\n                    ...\n                    afterBuild();\n                });\n            }\n        );\n    });\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br")])]),s("p",[s("code",[e._v("afterBuild")]),e._v("的回调，会导致"),s("code",[e._v("this._addModuleChain")]),e._v("返回，"),s("br"),e._v(" "),s("code",[e._v("compilation._addModuleChain")]),e._v("返回会导致"),s("code",[e._v("compiler.hooks.make")]),e._v("返回，"),s("br"),e._v("\n最后回到了"),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compiler.js#L537",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compiler.js 第537行"),s("OutboundLink")],1),e._v("。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("compile(callback) {\n    ...\n    this.hooks.beforeCompile.callAsync(params, err => {\n        ...\n        this.hooks.make.callAsync(compilation, err => {\n            // 这里\n        });\n    });\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br")])]),s("p",[e._v("到此为止，我们又回到了Compiler.js中，完成了"),s("code",[e._v("compiler.hooks.make")]),e._v("调用。")]),e._v(" "),s("h3",{attrs:{id:"_2-compilation-seal"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-compilation-seal"}},[e._v("#")]),e._v(" 2. compilation.seal")]),e._v(" "),s("p",[e._v("我们来到了"),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compiler.js#L537",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compiler.js 第537行"),s("OutboundLink")],1),e._v("，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("...\nthis.hooks.make.callAsync(compilation, err => {\n    ...\n    compilation.seal(err => {\n        ...\n    });\n});\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("p",[e._v("发现webpack在完成"),s("code",[e._v("compiler.hooks.make")]),e._v("之后，调用了"),s("code",[e._v("compilation.seal")]),e._v("，位于"),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L1159",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compilation.js 第1159行"),s("OutboundLink")],1),e._v("。"),s("br"),e._v("\n这是一个长达"),s("code",[e._v("143")]),e._v("行的函数，"),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L1159-L1301",target:"_blank",rel:"noopener noreferrer"}},[e._v("从1159-1301行"),s("OutboundLink")],1),e._v("，"),s("br"),e._v("\n在其中进行了大量的hooks操作。")]),e._v(" "),s("p",[e._v("下面我们来挑选两个重要的环节进行说明，一图胜千言，")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-31be3abf7abf1f41.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/539/format/webp",alt:""}})]),e._v(" "),s("h4",{attrs:{id:"_2-1-createchunkassets"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-createchunkassets"}},[e._v("#")]),e._v(" 2.1 createChunkAssets")]),e._v(" "),s("p",[e._v("第一个比较重要的环节是，"),s("code",[e._v("createChunkAssets")]),e._v("，"),s("br"),e._v("\n它会得到所有待生成的"),s("strong",[e._v("文件名")]),e._v("，以及"),s("strong",[e._v("未优化的文件内容")]),e._v("。")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-6d0c0bd357f257aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/356/format/webp",alt:""}})]),e._v(" "),s("p",[s("strong",[e._v("（1）调用")]),s("br"),e._v("\n对"),s("code",[e._v("createChunkAssets")]),e._v("的调用，位于 "),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L1270",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compilation.js 第1270行"),s("OutboundLink")],1),e._v("，"),s("br"),e._v("\n在调用之前，触发了"),s("code",[e._v("compilation.hooks.beforeChunkAssets")]),e._v("。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("if (this.hooks.shouldGenerateChunkAssets.call() !== false) {\n    this.hooks.beforeChunkAssets.call();\n    this.createChunkAssets();\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[s("strong",[e._v("（2）实现")]),s("br"),e._v(" "),s("code",[e._v("createChunkAssets")]),e._v("是"),s("code",[e._v("compilation")]),e._v("实例的一个方法，位于"),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L2313",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compilation.js 第2313行"),s("OutboundLink")],1),e._v("，"),s("br"),e._v("\n代码流程大体如下，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("createChunkAssets() {\n    ...\n    for (let i = 0; i < this.chunks.length; i++) {\n        ...\n        try {\n            ...\n            for (const fileManifest of manifest) {\n                ...\n                file = this.getPath(filenameTemplate, fileManifest.pathOptions);\n                ...\n                if (\n                    ...\n                ) {\n                    ...\n                } else {\n                    source = fileManifest.render();\n                    ...\n                }\n                ...\n                this.assets[file] = source;\n                ...\n                this.hooks.chunkAsset.call(chunk, file);\n                ...\n            }\n        } catch (err) {\n            ...\n        }\n    }\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br")])]),s("p",[e._v("调用"),s("code",[e._v("getPath")]),e._v("得到文件名"),s("code",[e._v("file")]),e._v("，然后调用"),s("code",[e._v("fileManifest.render")]),e._v("得到文件内容"),s("code",[e._v("source")]),e._v("。"),s("br"),e._v("\n最后保存到"),s("code",[e._v("compilation.assets")]),e._v("中。")]),e._v(" "),s("p",[e._v("我们来看一下示例工程"),s("a",{attrs:{href:"https://www.jianshu.com/p/2fa6562210ef",target:"_blank",rel:"noopener noreferrer"}},[e._v("debug-webpack"),s("OutboundLink")],1),e._v("中，"),s("code",[e._v("file")]),e._v("和"),s("code",[e._v("source")]),e._v("分别是什么。"),s("br"),e._v("\n在 "),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L2393",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compilation.js 第2393行"),s("OutboundLink")],1),e._v(" 打个断点。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("this.assets[file] = source;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[s("code",[e._v("file")]),e._v("的值是，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("index.js\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[s("code",[e._v("source")]),e._v("的值是，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('{\n    "_source": {\n        "children": [\n            "/******/ (function(modules) { // webpackBootstrap\\n",\n            {\n                "_source": {\n                    "_value": " \\t// The module cache\\n \\tvar installedModules = {};\\n\\n \\t// The require function\\n \\tfunction __webpack_require__(moduleId) {\\n\\n \\t\\t// Check if module is in cache\\n \\t\\tif(installedModules[moduleId]) {\\n \\t\\t\\treturn installedModules[moduleId].exports;\\n \\t\\t}\\n \\t\\t// Create a new module (and put it into the cache)\\n \\t\\tvar module = installedModules[moduleId] = {\\n \\t\\t\\ti: moduleId,\\n \\t\\t\\tl: false,\\n \\t\\t\\texports: {}\\n \\t\\t};\\n\\n \\t\\t// Execute the module function\\n \\t\\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\\n\\n \\t\\t// Flag the module as loaded\\n \\t\\tmodule.l = true;\\n\\n \\t\\t// Return the exports of the module\\n \\t\\treturn module.exports;\\n \\t}\\n\\n\\n \\t// expose the modules object (__webpack_modules__)\\n \\t__webpack_require__.m = modules;\\n\\n \\t// expose the module cache\\n \\t__webpack_require__.c = installedModules;\\n\\n \\t// define getter function for harmony exports\\n \\t__webpack_require__.d = function(exports, name, getter) {\\n \\t\\tif(!__webpack_require__.o(exports, name)) {\\n \\t\\t\\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\\n \\t\\t}\\n \\t};\\n\\n \\t// define __esModule on exports\\n \\t__webpack_require__.r = function(exports) {\\n \\t\\tif(typeof Symbol !== \'undefined\' && Symbol.toStringTag) {\\n \\t\\t\\tObject.defineProperty(exports, Symbol.toStringTag, { value: \'Module\' });\\n \\t\\t}\\n \\t\\tObject.defineProperty(exports, \'__esModule\', { value: true });\\n \\t};\\n\\n \\t// create a fake namespace object\\n \\t// mode & 1: value is a module id, require it\\n \\t// mode & 2: merge all properties of value into the ns\\n \\t// mode & 4: return value when already ns object\\n \\t// mode & 8|1: behave like require\\n \\t__webpack_require__.t = function(value, mode) {\\n \\t\\tif(mode & 1) value = __webpack_require__(value);\\n \\t\\tif(mode & 8) return value;\\n \\t\\tif((mode & 4) && typeof value === \'object\' && value && value.__esModule) return value;\\n \\t\\tvar ns = Object.create(null);\\n \\t\\t__webpack_require__.r(ns);\\n \\t\\tObject.defineProperty(ns, \'default\', { enumerable: true, value: value });\\n \\t\\tif(mode & 2 && typeof value != \'string\') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\\n \\t\\treturn ns;\\n \\t};\\n\\n \\t// getDefaultExport function for compatibility with non-harmony modules\\n \\t__webpack_require__.n = function(module) {\\n \\t\\tvar getter = module && module.__esModule ?\\n \\t\\t\\tfunction getDefault() { return module[\'default\']; } :\\n \\t\\t\\tfunction getModuleExports() { return module; };\\n \\t\\t__webpack_require__.d(getter, \'a\', getter);\\n \\t\\treturn getter;\\n \\t};\\n\\n \\t// Object.prototype.hasOwnProperty.call\\n \\t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\\n\\n \\t// __webpack_public_path__\\n \\t__webpack_require__.p = "";\\n\\n\\n \\t// Load entry module and return exports\\n \\treturn __webpack_require__(__webpack_require__.s = 0);\\n",\n                    "_name": "webpack/bootstrap"\n                },\n                "_prefix": "/******/"\n            },\n            "/******/ })\\n",\n            "/************************************************************************/\\n",\n            "/******/ (",\n            "[\\n",\n            "/* 0 */",\n            "\\n",\n            "/***/ (function(module, exports) {\\n\\n",\n            {\n                "_source": {\n                    "_source": {\n                        "_value": "alert();",\n                        "_name": "~/Test/debug-webpack/node_modules/_babel-loader@8.0.4@babel-loader/lib/index.js??ref--4!~/Test/debug-webpack/src/index.js"\n                    },\n                    "replacements": []\n                },\n                "_cachedMaps": {}\n            },\n            "\\n\\n/***/ })",\n            "\\n/******/ ]",\n            ")",\n            ";"\n        ]\n    },\n    "_cachedMaps": {}\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br")])]),s("p",[e._v("其中，"),s("code",[e._v("source._source.children")]),e._v("数组中包含了待优化的源码。"),s("br"),e._v("\n我们的源文件，在以上代码的第22行，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('"_value": "alert();"\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[s("strong",[e._v("（3）修改一下源文件")]),s("br"),e._v("\n我们修改一下 ./src/index.js 的内容，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("const a = 1;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("发现"),s("code",[e._v("source")]),e._v("中其他内容都没变，只有第22行改变了，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('"_value": "var a = 1;",\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("这里有一点值得注意，我们的源文件是使用babel-loader加载的，"),s("br"),e._v("\nbabel-loader加载后的文件，在内存中"),s("strong",[e._v("并不是AST")]),e._v("，而是转换后的代码。"),s("br"),e._v("\n在"),s("a",{attrs:{href:"https://www.jianshu.com/p/3ae8522fb098",target:"_blank",rel:"noopener noreferrer"}},[e._v("第四篇"),s("OutboundLink")],1),e._v("中，我们也提到了这一点。")]),e._v(" "),s("p",[e._v("因此，我们分析的"),s("code",[e._v("createChunkAssets")]),e._v("，与载入资源的时间点，并没有相距太远，"),s("br"),e._v("\n这里是直接拿到了babel-loader返回的结果，再增加了一些辅助代码，最后放入到"),s("code",[e._v("source")]),e._v("变量中。")]),e._v(" "),s("p",[s("strong",[e._v("（4）compilation.hooks.chunkAssets")]),s("br"),e._v(" "),s("code",[e._v("source")]),e._v("被保存到"),s("code",[e._v("compilation.assets")]),e._v("中之后，"),s("br"),e._v("\nwebpack就调用了"),s("code",[e._v("compilation.hooks.chunkAsset")]),e._v("。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("this.assets[file] = source;\n...\nthis.hooks.chunkAsset.call(chunk, file);\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("因此在写webpack插件时，我们可以利用这个hooks，获取"),s("code",[e._v("compilation.assets")]),e._v("。"),s("br"),e._v("\n在这个hooks之前，"),s("code",[e._v("compilation.assets")]),e._v("还没有值。")]),e._v(" "),s("h4",{attrs:{id:"_2-2-compilatin-hooks-optimizechunkassets"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-compilatin-hooks-optimizechunkassets"}},[e._v("#")]),e._v(" 2.2 compilatin.hooks.optimizeChunkAssets")]),e._v(" "),s("p",[e._v("获取了待生成的文件名"),s("code",[e._v("file")]),e._v("和文件内容"),s("code",[e._v("source")]),e._v("之后，剩下的另一个重要环节就是压缩了，"),s("br"),e._v("\n生成的代码会经过uglify-es进行压缩，"),s("br"),e._v("\n我们来看看这个过程是怎么进行的。")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://images.weserv.nl/?url=upload-images.jianshu.io/upload_images/1023733-335357861e66b657.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/350/format/webp",alt:""}})]),e._v(" "),s("p",[s("strong",[e._v("（1）optimizeChunkAssets")]),s("br"),e._v("\n上文中，我们讨论了，"),s("br"),e._v(" "),s("code",[e._v("compilation.seal")]),e._v("方法中，webpack在"),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L1270",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compilation.js 第1270行"),s("OutboundLink")],1),e._v(" 调用了"),s("code",[e._v("createChunkAssets")]),e._v("，"),s("br"),e._v("\n这件事完成之后，"),s("code",[e._v("compilation.assets")]),e._v("就有值了，"),s("br"),e._v("\n其中包含了待生成的文件名"),s("code",[e._v("file")]),e._v("和文件内容"),s("code",[e._v("source")]),e._v("。")]),e._v(" "),s("p",[e._v("于是紧接着，后面仍然还是在"),s("code",[e._v("compilation.seal")]),e._v("中，"),s("br"),e._v("\nwebpack在"),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L1282",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compilation.js 第1282行"),s("OutboundLink")],1),e._v(" 调用了 "),s("code",[e._v("compilatin.hooks.optimizeChunkAssets")]),e._v("，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("this.hooks.optimizeChunkAssets.callAsync(this.chunks, err => {\n    ...\n});\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("这里调试起来很困难，要跟进到tapable代码库里面，"),s("br"),e._v("\n最终我们找到了，这个hooks是由 uglifyjs-webpack-plugin（v1.3.0） 实现的。"),s("br"),e._v("\n本地路径在这里，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("~/Test/debug-webpack/node_modules/_uglifyjs-webpack-plugin@1.3.0@uglifyjs-webpack-plugin/dist/index.js\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("源码位置，在 "),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/index.js#L339",target:"_blank",rel:"noopener noreferrer"}},[e._v("uglifyjs-webpack-plugin/src/index.js 第339行"),s("OutboundLink")],1),e._v("，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("compilation.hooks.optimizeChunkAssets.tapAsync(plugin, optimizeFn.bind(this, compilation));\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[s("strong",[e._v("注：")]),s("br"),e._v("\n在进行调试的时候，我们只能跟进node_modules中uglifyjs-webpack-plugin的安装包内，"),s("br"),e._v("\n这些代码都是编译后的，存在于dist文件夹中，"),s("br"),e._v("\n为了便于理解，我们后面贴代码的话，都像上面这样，贴uglifyjs-webpack-plugin github仓库的源码。")]),e._v(" "),s("p",[s("strong",[e._v("（2）uglifyjs-webpack-plugin（v1.3.0）")]),s("br"),e._v("\nuglifyjs-webpack-plugin 实现了"),s("code",[e._v("compilation.hooks.optimizeChunkAssets")]),e._v("，"),s("br"),e._v("\n具体是代码逻辑在"),s("code",[e._v("optimizeFn")]),e._v(" 中，位于 "),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/index.js#L130",target:"_blank",rel:"noopener noreferrer"}},[e._v("index.js 第130行"),s("OutboundLink")],1),e._v("。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("const optimizeFn = (compilation, chunks, callback) => {\n    ...\n    runner.runTasks(tasks, (tasksError, results) => {\n        ...\n        callback();\n    });\n};\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("p",[e._v("这又是一个长函数，从"),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/index.js#L130-L328",target:"_blank",rel:"noopener noreferrer"}},[e._v("index.js 第130行-第328行"),s("OutboundLink")],1),e._v("，总共"),s("code",[e._v("199")]),e._v("行。"),s("br"),e._v("\n它先创建了一些"),s("code",[e._v("tasks")]),e._v("，然后用"),s("code",[e._v("runner")]),e._v("去运行这些"),s("code",[e._v("tasks")]),e._v("。"),s("br"),e._v(" "),s("code",[e._v("tasks")]),e._v("执行完之后，调用"),s("code",[e._v("callback")]),e._v("，会导致"),s("code",[e._v("compilation.hooks.optimizeChunkAssets")]),e._v("返回。")]),e._v(" "),s("p",[e._v("其中，"),s("code",[e._v("runner")]),e._v("由 "),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/uglify/Runner.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("uglifyjs-webpack-plugin/src/uglify/Runner.js"),s("OutboundLink")],1),e._v(" 导出。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("export default class Runner {\n    ...\n    runTasks(tasks, callback) {\n        ...\n    }\n    ...\n}\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("p",[s("code",[e._v("runTasks")]),e._v("的实现位于，"),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/blob/v1.3.0/src/uglify/Runner.js#L25",target:"_blank",rel:"noopener noreferrer"}},[e._v("Runner.js 第25行"),s("OutboundLink")],1),e._v("。​"),s("br"),e._v(" "),s("code",[e._v("runTasks")]),e._v("主要做了两件重要的事情，"),s("br"),e._v("\n一个是使用Node.js内置模块 "),s("strong",[e._v("child_process")]),e._v("，对代码进行"),s("strong",[e._v("压缩")]),e._v("（minify）"),s("br"),e._v("\n另一个，则是对uglifyjs minify的结果进行"),s("strong",[e._v("缓存")]),e._v("。")]),e._v(" "),s("p",[e._v("我们下一篇中再详细介绍。")]),e._v(" "),s("p",[s("strong",[e._v("（3）回到compilation.seal")]),s("br"),e._v("\n上文提到，uglifyjs-webpack-plugin 中"),s("code",[e._v("optimizeFn")]),e._v(" 执行完后调用"),s("code",[e._v("callback")]),e._v("，"),s("br"),e._v("\n会导致"),s("code",[e._v("tasks")]),e._v("执行完之后，调用"),s("code",[e._v("callback")]),e._v("，会导致"),s("code",[e._v("compilation.hooks.optimizeChunkAssets")]),e._v("返回。")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("const optimizeFn = (compilation, chunks, callback) => {\n    ...\n    runner.runTasks(tasks, (tasksError, results) => {\n        ...\n        callback();\n    });\n};\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("p",[e._v("执行流程就回到了 "),s("a",{attrs:{href:"https://github.com/webpack/webpack/blob/v4.20.2/lib/Compilation.js#L1283",target:"_blank",rel:"noopener noreferrer"}},[e._v("Compilation.js 第1283行"),s("OutboundLink")],1),e._v("，它位于"),s("code",[e._v("compilation.seal")]),e._v("函数中，")]),e._v(" "),s("p",[e._v("**")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("this.hooks.optimizeChunkAssets.callAsync(this.chunks, err => {\n    // 这里\n});\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("至于uglifyjs-webpack-plugin中，到底是如何进行压缩和缓存的，"),s("br"),e._v("\ncompilation.seal后续又做了哪些事情，"),s("br"),e._v("\n且听我下回分解。")]),e._v(" "),s("hr"),e._v(" "),s("h3",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[e._v("#")]),e._v(" 参考")]),e._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/webpack/webpack/tree/v4.20.2",target:"_blank",rel:"noopener noreferrer"}},[e._v("webpack v4.20.2"),s("OutboundLink")],1),s("br"),e._v(" "),s("a",{attrs:{href:"https://github.com/webpack-contrib/uglifyjs-webpack-plugin/tree/v1.3.0",target:"_blank",rel:"noopener noreferrer"}},[e._v("uglifyjs-webpack-plugin v1.3.0"),s("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=t.exports}}]);