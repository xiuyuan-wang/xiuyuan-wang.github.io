<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>倘若有一天</title>
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" href="/header.jpg">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.a427340b.css" as="style"><link rel="preload" href="/assets/js/app.282508ef.js" as="script"><link rel="preload" href="/assets/js/2.a1cbaef5.js" as="script"><link rel="preload" href="/assets/js/94.3262e5a7.js" as="script"><link rel="prefetch" href="/assets/js/10.2c98332c.js"><link rel="prefetch" href="/assets/js/100.393ab2a4.js"><link rel="prefetch" href="/assets/js/101.78c1f8b6.js"><link rel="prefetch" href="/assets/js/102.85d15ad3.js"><link rel="prefetch" href="/assets/js/103.b2c501a5.js"><link rel="prefetch" href="/assets/js/104.c0ed595d.js"><link rel="prefetch" href="/assets/js/105.f15f5366.js"><link rel="prefetch" href="/assets/js/106.61151c5e.js"><link rel="prefetch" href="/assets/js/107.d39240eb.js"><link rel="prefetch" href="/assets/js/108.f716bda5.js"><link rel="prefetch" href="/assets/js/109.fbc135d0.js"><link rel="prefetch" href="/assets/js/11.f005400c.js"><link rel="prefetch" href="/assets/js/110.3928667b.js"><link rel="prefetch" href="/assets/js/111.b13a0b48.js"><link rel="prefetch" href="/assets/js/112.7b5006f4.js"><link rel="prefetch" href="/assets/js/113.0d31f132.js"><link rel="prefetch" href="/assets/js/114.2bb5d9e1.js"><link rel="prefetch" href="/assets/js/115.5e64c1e5.js"><link rel="prefetch" href="/assets/js/116.3ee73b77.js"><link rel="prefetch" href="/assets/js/117.f50cff54.js"><link rel="prefetch" href="/assets/js/118.2689f48f.js"><link rel="prefetch" href="/assets/js/119.6426d3f6.js"><link rel="prefetch" href="/assets/js/12.cf3e63d8.js"><link rel="prefetch" href="/assets/js/120.363e12a7.js"><link rel="prefetch" href="/assets/js/121.85ec9cf3.js"><link rel="prefetch" href="/assets/js/13.81302ba4.js"><link rel="prefetch" href="/assets/js/14.9afc1667.js"><link rel="prefetch" href="/assets/js/15.c564a464.js"><link rel="prefetch" href="/assets/js/16.3f8c98ff.js"><link rel="prefetch" href="/assets/js/17.1d432112.js"><link rel="prefetch" href="/assets/js/18.66992dd5.js"><link rel="prefetch" href="/assets/js/19.3a5615bc.js"><link rel="prefetch" href="/assets/js/20.9e0b5237.js"><link rel="prefetch" href="/assets/js/21.f51d933b.js"><link rel="prefetch" href="/assets/js/22.aaa8538e.js"><link rel="prefetch" href="/assets/js/23.e4f94cd3.js"><link rel="prefetch" href="/assets/js/24.5deee84c.js"><link rel="prefetch" href="/assets/js/25.9b363258.js"><link rel="prefetch" href="/assets/js/26.c6083244.js"><link rel="prefetch" href="/assets/js/27.9ebc4263.js"><link rel="prefetch" href="/assets/js/28.d4a74cd6.js"><link rel="prefetch" href="/assets/js/29.bb4db167.js"><link rel="prefetch" href="/assets/js/3.17384045.js"><link rel="prefetch" href="/assets/js/30.3b68b547.js"><link rel="prefetch" href="/assets/js/31.58ba7ddf.js"><link rel="prefetch" href="/assets/js/32.886b3dd0.js"><link rel="prefetch" href="/assets/js/33.5e65a6cc.js"><link rel="prefetch" href="/assets/js/34.25b5b82b.js"><link rel="prefetch" href="/assets/js/35.f8d6f114.js"><link rel="prefetch" href="/assets/js/36.aea7921b.js"><link rel="prefetch" href="/assets/js/37.5c6156f9.js"><link rel="prefetch" href="/assets/js/38.588a6193.js"><link rel="prefetch" href="/assets/js/39.e9ceb0e8.js"><link rel="prefetch" href="/assets/js/4.ac8c0f23.js"><link rel="prefetch" href="/assets/js/40.9acab66e.js"><link rel="prefetch" href="/assets/js/41.97497b1c.js"><link rel="prefetch" href="/assets/js/42.873f16b5.js"><link rel="prefetch" href="/assets/js/43.4d558e3f.js"><link rel="prefetch" href="/assets/js/44.645dab32.js"><link rel="prefetch" href="/assets/js/45.1f2b148b.js"><link rel="prefetch" href="/assets/js/46.f6b30a8a.js"><link rel="prefetch" href="/assets/js/47.6f082f8d.js"><link rel="prefetch" href="/assets/js/48.ce777f64.js"><link rel="prefetch" href="/assets/js/49.570a21ec.js"><link rel="prefetch" href="/assets/js/5.8a91f847.js"><link rel="prefetch" href="/assets/js/50.7d81323a.js"><link rel="prefetch" href="/assets/js/51.0303e90b.js"><link rel="prefetch" href="/assets/js/52.97f8b439.js"><link rel="prefetch" href="/assets/js/53.3fd3c6a9.js"><link rel="prefetch" href="/assets/js/54.d0eb83b3.js"><link rel="prefetch" href="/assets/js/55.32fdcecc.js"><link rel="prefetch" href="/assets/js/56.fbfc09a3.js"><link rel="prefetch" href="/assets/js/57.547120c7.js"><link rel="prefetch" href="/assets/js/58.8ca04f20.js"><link rel="prefetch" href="/assets/js/59.50e6f206.js"><link rel="prefetch" href="/assets/js/6.c966999c.js"><link rel="prefetch" href="/assets/js/60.03d4b566.js"><link rel="prefetch" href="/assets/js/61.03af23bf.js"><link rel="prefetch" href="/assets/js/62.cf5f882a.js"><link rel="prefetch" href="/assets/js/63.8389c2c6.js"><link rel="prefetch" href="/assets/js/64.56a6a39f.js"><link rel="prefetch" href="/assets/js/65.2934948c.js"><link rel="prefetch" href="/assets/js/66.e050480c.js"><link rel="prefetch" href="/assets/js/67.a03accad.js"><link rel="prefetch" href="/assets/js/68.fa9364ed.js"><link rel="prefetch" href="/assets/js/69.2fbeaf39.js"><link rel="prefetch" href="/assets/js/7.971eb831.js"><link rel="prefetch" href="/assets/js/70.89ef1589.js"><link rel="prefetch" href="/assets/js/71.a41e8134.js"><link rel="prefetch" href="/assets/js/72.ba2ffe87.js"><link rel="prefetch" href="/assets/js/73.113b3d76.js"><link rel="prefetch" href="/assets/js/74.4dd54a46.js"><link rel="prefetch" href="/assets/js/75.98bbb07f.js"><link rel="prefetch" href="/assets/js/76.6cee2f65.js"><link rel="prefetch" href="/assets/js/77.0bc53ebb.js"><link rel="prefetch" href="/assets/js/78.8617cec2.js"><link rel="prefetch" href="/assets/js/79.137d3747.js"><link rel="prefetch" href="/assets/js/8.c941beae.js"><link rel="prefetch" href="/assets/js/80.130e6609.js"><link rel="prefetch" href="/assets/js/81.0b3bf721.js"><link rel="prefetch" href="/assets/js/82.982380fc.js"><link rel="prefetch" href="/assets/js/83.501eca82.js"><link rel="prefetch" href="/assets/js/84.66e5994c.js"><link rel="prefetch" href="/assets/js/85.df1ae8de.js"><link rel="prefetch" href="/assets/js/86.565baee7.js"><link rel="prefetch" href="/assets/js/87.3244d4ef.js"><link rel="prefetch" href="/assets/js/88.f104eed0.js"><link rel="prefetch" href="/assets/js/89.592f4c57.js"><link rel="prefetch" href="/assets/js/9.1002202d.js"><link rel="prefetch" href="/assets/js/90.db5ee901.js"><link rel="prefetch" href="/assets/js/91.2acf88e1.js"><link rel="prefetch" href="/assets/js/92.23834236.js"><link rel="prefetch" href="/assets/js/93.33612d70.js"><link rel="prefetch" href="/assets/js/95.48027147.js"><link rel="prefetch" href="/assets/js/96.a9ed0cf0.js"><link rel="prefetch" href="/assets/js/97.48930c53.js"><link rel="prefetch" href="/assets/js/98.4a046e5f.js"><link rel="prefetch" href="/assets/js/99.aff15256.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a427340b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header.jpg" alt="倘若有一天" class="logo"> <span class="site-name can-hide">倘若有一天</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knows/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  数据可视化
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knows/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  数据可视化
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端方案</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knows/project/001.html" class="sidebar-link">指南</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>即时通讯</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knows/project/即时通讯/浏览器断网联网事件.html" class="sidebar-link">浏览器断网联网事件</a></li><li><a href="/knows/project/即时通讯/如何让定时器在页面最小化的时候不执行.html" class="sidebar-link">如何让定时器在页面最小化的时候不执行</a></li><li><a href="/knows/project/即时通讯/消息推送7种方案.html" class="sidebar-link">消息推送7种方案</a></li><li><a href="/knows/project/即时通讯/为什么不用TCP的keepalive设计心跳.html" class="sidebar-link">为什么不用TCP的keepalive设计心跳</a></li><li><a href="/knows/project/即时通讯/一套高效的IM长连接自适应心跳保活机制.html" class="active sidebar-link">一套高效的IM长连接自适应心跳保活机制</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/knows/project/即时通讯/搭建websocket消息推送服务必须要考虑的几个问题.html" class="sidebar-link">搭建websocket消息推送服务必须要考虑的几个问题</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>前端监控</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/knows/project/PWA/使用offline-plugin实现PWA.html" class="sidebar-link">使用offline-plugin实现PWA</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>微前端</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="https://mp.weixin.qq.com/s?__biz=MzUxMzcxMzE5Ng==&amp;mid=2247488488&amp;idx=1&amp;sn=f76fb0a8f88f6958d6a7ecfe6658b5a5&amp;source=41#wechat_redirect" target="_blank" rel="noopener noreferrer">微信Android客户端后台保活经验分享<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>本文作者“Carson”，现就职于腾讯公司，原题“高效保活长连接：手把手教你实现自适应的心跳保活机制”，有较多修订和改动。</p> <h1 id="_1、引言"><a href="#_1、引言" class="header-anchor">#</a> 1、引言</h1> <p>当要实现IM即时通讯聊天、消息推送等高实时性需求时，我们一般会选择长连接的通信方式。</p> <p>而真正当实现长连接方式时，会遇到很多技术问题，比如最常见的长连接保活问题。</p> <p>今天， <strong>我将通过本篇文章，手把手教大家实现一套可自适应的心跳保活机制，从而能高效稳定地维持诸如IM聊天这类需求的长连接。</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f2b1ac1f73cb4b1aa20f6af1c8240f7d~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <h1 id="_2、相关文章"><a href="#_2、相关文章" class="header-anchor">#</a> 2、相关文章</h1> <ol><li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-281-1-1.html" title="http://www.52im.net/thread-281-1-1.html" target="_blank" rel="noopener noreferrer">为何基于TCP协议的移动端IM仍然需要心跳保活机制？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2697-1-1.html" title="http://www.52im.net/thread-2697-1-1.html" target="_blank" rel="noopener noreferrer">一文读懂即时通讯应用中的网络心跳包机制：作用、原理、实现思路等<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-783-1-1.html" title="http://www.52im.net/thread-783-1-1.html" target="_blank" rel="noopener noreferrer">一种Android端IM智能心跳算法的设计与实现探讨（含样例代码）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2671-1-1.html" title="http://www.52im.net/thread-2671-1-1.html" target="_blank" rel="noopener noreferrer">自已开发IM有那么难吗？手把手教你自撸一个Andriod版简易IM (有源码)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2663-1-1.html" title="http://www.52im.net/thread-2663-1-1.html" target="_blank" rel="noopener noreferrer">跟着源码学IM(一)：手把手教你用Netty实现心跳机制、断线重连机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2799-1-1.html" title="http://www.52im.net/thread-2799-1-1.html" target="_blank" rel="noopener noreferrer">跟着源码学IM(五)：正确理解IM长连接、心跳及重连机制，并动手实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li></ol> <h1 id="_3、什么是长连接"><a href="#_3、什么是长连接" class="header-anchor">#</a> 3、什么是长连接</h1> <p><strong>认识长连接：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d698fb3d65c640e2ba778b489d88012b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>长连接的主要作是通过长时间保持双方连接，从而：</strong></p> <ul><li>1）提高通信速度；</li> <li>2）确保实时性；</li> <li>3）避免短时间内重复连接所造成的信道资源和网络资源的浪费。</li></ul> <p><strong>长连接与短连接的区别：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2a154bde06844cb7b7f69ca0cd2b32ff~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>PS：</strong> 对于IM这类的开发者而言，通常大家都把HTTP协议称“短连接”、把直接基于<a href="https://link.juejin.cn?target=http%3A%2F%2Fdocs.52im.net%2Fextend%2Fdocs%2Fbook%2Ftcpip%2Fvol1%2F17%2F" title="http://docs.52im.net/extend/docs/book/tcpip/vol1/17/" target="_blank" rel="noopener noreferrer">TCP<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://link.juejin.cn?target=http%3A%2F%2Fdocs.52im.net%2Fextend%2Fdocs%2Fbook%2Ftcpip%2Fvol1%2F11%2F" title="http://docs.52im.net/extend/docs/book/tcpip/vol1/11/" target="_blank" rel="noopener noreferrer">UDP<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>或<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3713-1-1.html" title="http://www.52im.net/thread-3713-1-1.html" target="_blank" rel="noopener noreferrer">WebSocket<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的socket称为“长连接”。</p> <h1 id="_4、导致长连接断开的原因"><a href="#_4、导致长连接断开的原因" class="header-anchor">#</a> 4、导致长连接断开的原因</h1> <h3 id="_4-1-基本概念"><a href="#_4-1-基本概念" class="header-anchor">#</a> 4.1 基本概念</h3> <p>从上节可知，在使用长连接的情况下，双方的所有通信都建立在1条长连接上（比如1次TCP连接）。所以，长连接需要持续保持双方连接才可使得双方持续通信。</p> <p>然而，实际情况是，长连接会存在断开的情况。</p> <p><strong>这些断开原因主要是：</strong></p> <ul><li>1）长连接所在进程被杀死（这主要说的是移动端）；</li> <li>2）NAT超时；</li> <li>3）网络状态发生变化；</li> <li>4）其他不可抗因素（网络状态差、DHCP的租期等等 ）。</li></ul> <p>下面，我将对每种原因进行分析。</p> <h3 id="_4-2-具体分析"><a href="#_4-2-具体分析" class="header-anchor">#</a> 4.2 具体分析</h3> <p><strong>1）原因1：进程被杀死</strong></p> <p>当进程被杀死后，长连接也会随之断开。进程被杀在Andriod端是最常见的问题，限于篇幅就不在此展开这个话题，有兴趣可以阅读这篇：《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-1832-1-1.html" title="http://www.52im.net/thread-1832-1-1.html" target="_blank" rel="noopener noreferrer">Android P正式版即将到来：后台应用保活、消息推送的真正噩梦<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》。</p> <p><strong>2）原因2：NAT 超时（重点关注）</strong></p> <p><strong>NAT超时现象如下：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/72fe895759c4409abc5cccbdceedea22~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>各运营商和地区的NAT超时时间如下：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e771c97e554a4935b70e546a1f3da1b7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>PS：</strong> 上述数据来源于微信团队的《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-120-1-1.html" title="http://www.52im.net/thread-120-1-1.html" target="_blank" rel="noopener noreferrer">移动端IM实践：实现Android版微信的智能心跳机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》一文，随着4G、5G的普及，这些数据有可能已发生变化，请以实际测试结果为准。</p> <p><strong>特别注意：</strong> 排除其他外因（网络切换、NAT超时、人为原因），TCP长连接在双方都不断开连接的情况上，本质上是不会自动中断的（也就是不需要心跳包来维持，可以验证一下：让2台电脑连上同1个Wifi，其中1台做服务器, 另1台做客户端连接服务器（无设置KeepAlive）。只要电脑、路由器不断网断电，那么，2台电脑的长连接是不会自动中断的）。</p> <p><strong>Jack Jiang注：</strong> 上述论述可能不太准确，有新兴趣的读者可以详读《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3846-1-1.html" title="http://www.52im.net/thread-3846-1-1.html" target="_blank" rel="noopener noreferrer">拔掉网线再插上，TCP连接还在吗？一文即懂！<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》。</p> <p><strong>3）原因3：网络状态发生变化</strong></p> <p>当移动客户端网络状态发生变化时（如移动网络 &amp; Wifi切换、断开、重连），也会使长连接断开。</p> <p><strong>4）原因4：其他不可抗因素</strong></p> <p>如网络状态差、DHCP的租期到期等等，都会使得长连接发生 偶然的断开。DHCP的租期到期：对于 Android系统， DHCP到了租期后不会主动续约（继续使用过期IP），从而导致长连接断开。</p> <h1 id="_5、高效维持长连接的解决方案"><a href="#_5、高效维持长连接的解决方案" class="header-anchor">#</a> 5、高效维持长连接的解决方案</h1> <h3 id="_5-1-基本介绍"><a href="#_5-1-基本介绍" class="header-anchor">#</a> 5.1 基本介绍</h3> <p>在了解长连接断开原因后，针对这些原因，此处给出我的高效维持长连接的解决方案（如下图所示）。</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b77fed4fdd3d4a93b10b81d377dbe277~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>为此，若需有效维持长连接，则需要做到：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd664e0c1451438aaedfa0c093adfb03~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>说得简单点，高效维持长连接的关键在于：</strong></p> <ul><li>1）保活：处于连接状态时要做到尽量不要断；</li> <li>2）重连：连接断了之后要能继续重连回来。</li></ul> <h3 id="_5-2-具体措施"><a href="#_5-2-具体措施" class="header-anchor">#</a> 5.2 具体措施</h3> <p><strong>1）措施1：进程保活</strong></p> <p><strong>整体概括如下：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/29233edb5e1f4f62a42549182468b9b7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>PS：</strong> 关于Android的进程保活，这个话题就很热门了，感兴趣可以顺着下面的文章详细读一读：</p> <ol><li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-1135-1-1.html" title="http://www.52im.net/thread-1135-1-1.html" target="_blank" rel="noopener noreferrer">应用保活终极总结(一)：Android6.0以下的双进程守护保活实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-1138-1-1.html" title="http://www.52im.net/thread-1138-1-1.html" target="_blank" rel="noopener noreferrer">应用保活终极总结(二)：Android6.0及以上的保活实践(进程防杀篇)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-1140-1-1.html" title="http://www.52im.net/thread-1140-1-1.html" target="_blank" rel="noopener noreferrer">应用保活终极总结(三)：Android6.0及以上的保活实践(被杀复活篇)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-438-1-1.html" title="http://www.52im.net/thread-438-1-1.html" target="_blank" rel="noopener noreferrer">Android进程保活详解：一篇文章解决你的所有疑问<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-210-1-1.html" title="http://www.52im.net/thread-210-1-1.html" target="_blank" rel="noopener noreferrer">微信团队原创分享：Android版微信后台保活实战分享(进程保活篇)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-1832-1-1.html" title="http://www.52im.net/thread-1832-1-1.html" target="_blank" rel="noopener noreferrer">Android P正式版即将到来：后台应用保活、消息推送的真正噩梦<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2176-1-1.html" title="http://www.52im.net/thread-2176-1-1.html" target="_blank" rel="noopener noreferrer">全面盘点当前Android后台保活方案的真实运行效果（截止2019年前）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2881-1-1.html" title="http://www.52im.net/thread-2881-1-1.html" target="_blank" rel="noopener noreferrer">2020年了，Android后台保活还有戏吗？看我如何优雅的实现！<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2893-1-1.html" title="http://www.52im.net/thread-2893-1-1.html" target="_blank" rel="noopener noreferrer">史上最强Android保活思路：深入剖析腾讯TIM的进程永生技术<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2921-1-1.html" title="http://www.52im.net/thread-2921-1-1.html" target="_blank" rel="noopener noreferrer">Android进程永生技术终极揭密：进程被杀底层原理、APP应对被杀技巧<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3033-1-1.html" title="http://www.52im.net/thread-3033-1-1.html" target="_blank" rel="noopener noreferrer">Android保活从入门到放弃：乖乖引导用户加白名单吧(附7大机型加白示例)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li></ol> <p><strong>2）措施2：心跳保活机制</strong></p> <p>这是本文的重点，下节开始会详细解析</p> <p><strong>3）措施3：断线重连机制</strong></p> <p><strong>原理就是：</strong> 检测网络状态变化并及时判断连接的有效性。</p> <p><strong>具体实现：</strong> 这个其实跟心跳保活机制是一套完整的逻辑，所以下面会在心跳保活机制中一起讲解。</p> <h1 id="_6、心跳保活机制简介"><a href="#_6、心跳保活机制简介" class="header-anchor">#</a> 6、心跳保活机制简介</h1> <p><strong>心跳保活机制的整体介绍如下：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e0c25ec6e164096845ca6d360c1ac55~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p>不过，很多人容易混淆把心跳机制和传统的HTTP轮询机制搞混。</p> <p><strong>下面给出二者区别：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/38821873010f46eeb18ccd8a9e0893a2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <h1 id="_7、主流im的心跳机制分析和对比"><a href="#_7、主流im的心跳机制分析和对比" class="header-anchor">#</a> 7、主流IM的心跳机制分析和对比</h1> <p>对国、内外主流的移动IM产品（WhatsApp、Line、微信）进行了心跳机制的简单分析和对比。</p> <p><strong>具体请看下图：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b007f480277b4847ab1cb193cb7a70fc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>PS：</strong> 以上数据来自于微信团队分享的《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-121-1-1.html" title="http://www.52im.net/thread-121-1-1.html" target="_blank" rel="noopener noreferrer">移动端IM实践：WhatsApp、Line、微信的心跳策略分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》一文。</p> <h1 id="_8、心跳保活机制方案总体设计"><a href="#_8、心跳保活机制方案总体设计" class="header-anchor">#</a> 8、心跳保活机制方案总体设计</h1> <p>下面，我将根据市面上主流的心跳机制，设计了一套心跳机制方案。</p> <p><strong>心跳机制方案的基本流程：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2c919634f4834879a9ea08ff9ab3a057~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>对于心跳机制方案设计的主要考虑因素是：</strong></p> <ul><li>1）要保证消息的实时性；</li> <li>2）要考虑耗费设备的资源（网络流量、电量、CPU等等）。</li></ul> <p><strong>从上图可以看出，对于心跳机制方案设计的要点在于：</strong></p> <ul><li>1）心跳包的规格（内容 &amp; 大小）；</li> <li>2）心跳发送的间隔时间；</li> <li>3）断线重连机制 （核心 = 如何 判断长连接的有效性）。</li></ul> <p>在下面的方案设计中，将针对这3个问题给出详细的解决方案。</p> <h1 id="_9、心跳机制方案的详细设计"><a href="#_9、心跳机制方案的详细设计" class="header-anchor">#</a> 9、心跳机制方案的详细设计</h1> <h3 id="_9-1-心跳包的规格"><a href="#_9-1-心跳包的规格" class="header-anchor">#</a> 9.1 心跳包的规格</h3> <p>为了减少流量并提高发送效率，需要精简心跳包的设计。</p> <p><strong>主要从心跳包的内容和大小入手，设计原则具体如下：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54cdde8ba15e4700a9ae9dc702f708f7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>设计方案：</strong></p> <blockquote><p>心跳包 = 1个携带少量信息 &amp; 大小在10字节内的信息包</p></blockquote> <h3 id="_9-2-心跳发送的间隔时间"><a href="#_9-2-心跳发送的间隔时间" class="header-anchor">#</a> 9.2 心跳发送的间隔时间</h3> <p>为了 防止NAT超时并减少设备资源的消耗（网络流量、电量、CPU等等），心跳发送的间隔时间是整个心跳机制方案设计的重点。</p> <p><strong>心跳发送间隔时间的设计原则如下：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/71ea02de9bcc4160842bd8ccc9b756d8~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <h3 id="_9-3-最常用的心跳间隔方案"><a href="#_9-3-最常用的心跳间隔方案" class="header-anchor">#</a> 9.3 最常用的心跳间隔方案</h3> <p>一般，最直接且常用的心跳发送间隔时间设置方案多采用：“每隔估计 x 分钟发送心跳包1次”。其中，x ＜5分钟即可（综合主流移动IM产品，此处建议 x= 4分钟）。</p> <p><strong>但是，这种方案存在一些问题：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f7a06d7a935e47a2b3ab3398f0a559c1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>PS：</strong> 关于固定心跳间隔的方案具体实现，可以详细参考：</p> <ol><li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2663-1-1.html" title="http://www.52im.net/thread-2663-1-1.html" target="_blank" rel="noopener noreferrer">跟着源码学IM(一)：手把手教你用Netty实现心跳机制、断线重连机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》；</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2799-1-1.html" title="http://www.52im.net/thread-2799-1-1.html" target="_blank" rel="noopener noreferrer">跟着源码学IM(五)：正确理解IM长连接、心跳及重连机制，并动手实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》；</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2671-1-1.html" title="http://www.52im.net/thread-2671-1-1.html" target="_blank" rel="noopener noreferrer">自已开发IM有那么难吗？手把手教你自撸一个Andriod版简易IM (有源码)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》。</li></ol> <h3 id="_9-4-自适应心跳间隔方案"><a href="#_9-4-自适应心跳间隔方案" class="header-anchor">#</a> 9.4 自适应心跳间隔方案</h3> <p>下面，我将详细讲解自适应心跳间隔时间的设计方案。</p> <p><strong>基本逻辑：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1244f38a63304abbb2d24582f4b1c973~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p>该方案需要解决的有2个核心问题。</p> <p><strong>1）如何自适应计算心跳间隔 从而使得心跳间隔 接近 当前NAT 超时时间？</strong></p> <p><strong>答：</strong> 不断增加心跳间隔时间进行心跳应答测试，直到心跳失败5次后，即可找出最接近 当前NAT 超时时间的心跳间隔时间。</p> <p><strong>具体请看下图：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c1f66c40e4934daf9dfcb0062facd65e~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p>**注：**只有当心跳间隔 接近 NAT 超时时间 时，才能最大化平衡 长连接不中断 &amp; 设备资源消耗最低的问题。</p> <p><strong>2）如何检测 当前网络环境的NAT 超时时间 发生了变化 ？</strong></p> <p>**答：**当前发送心跳包成功 的最大间隔时间（即最接近NAT超时时间的心跳间隔） 发送失败5次后，则判断当前网络环境的NAT 超时时间 发生了变化。</p> <p><strong>具体请看下图：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/34a52be1080b4ba29c546b71d0ee2d12~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>注：</strong> 在检测到 NAT 超时时间 发生变化后，重新自适应计算心跳间隔 从而使得心跳间隔 接近 NAT 超时时间</p> <p><strong>总结一下：</strong> 统筹以上2个核心问题，总结出自适应心跳间隔时间设计方案为下图：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e39e8fcfd6247f2aa6ec5a13faf5d96~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>PS：</strong> 关于自适应心跳机制的设计和实现，可以详细参考：</p> <ol><li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-120-1-1.html" title="http://www.52im.net/thread-120-1-1.html" target="_blank" rel="noopener noreferrer">移动端IM实践：实现Android版微信的智能心跳机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》；</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-783-1-1.html" title="http://www.52im.net/thread-783-1-1.html" target="_blank" rel="noopener noreferrer">一种Android端IM智能心跳算法的设计与实现探讨（含样例代码）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》。</li></ol> <h1 id="_10、断线重连机制的实现"><a href="#_10、断线重连机制的实现" class="header-anchor">#</a> 10、断线重连机制的实现</h1> <p>技术上来说：长连接的心跳保活依赖于心跳机制，在心跳机制起作用的情况下，适时启动断线重连机制，在心跳机制和断线重连机制的共同作用下才能实现真正的心跳保活。但为了让逻辑更清晰，我把断线重连机制跟心跳机制单独各作为一节来讲解。本节讲的是断片线重连机制。</p> <p>该机制的核心在于：如何判断长连接的有效性。即：什么情况下视为长连接断线？</p> <p><strong>1）设计原则：</strong></p> <p><strong>基本逻辑就是：</strong> 判断长连接是否有效的准则 = 服务器是否返回心跳应答。</p> <p><strong>此处需要分清长连接的“存活 &amp; 有效“状态的区别：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/690913e3026f423191a1026522bc9935~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>2）具体方案：</strong></p> <p>实现思路：通过计数计算，若连续5次发送心跳后，服务器都无心跳应答，则视为长连接无效。</p> <p><strong>判断流程：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99216c385b95444f99b9687a0c5e637f~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>3）网上流传的方案：</strong></p> <p><strong>在网上流传着一些用于判断长连接是否有效的方案，具体介绍如下：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ab3c344293d0401fa83412d070e61918~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p>至此，关于心跳保活机制已经讲解完毕。</p> <h1 id="_11、方案小结"><a href="#_11、方案小结" class="header-anchor">#</a> 11、方案小结</h1> <p>有必要总结一下我在上两节分享的心跳机制和断线重连机制，这两个机制组成了本文的长连接心跳保活完整逻辑。</p> <p><strong>设计方案：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/940d2e5ee90b43988b2dfb62695d1bd1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>流程设计：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/258dd72890584ab896de1d74c94718d1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>注：</strong> 标识 “灰色” 的判断流程参考上文描述。</p> <h1 id="_12、进一步优化和完善心跳保活方案"><a href="#_12、进一步优化和完善心跳保活方案" class="header-anchor">#</a> 12、进一步优化和完善心跳保活方案</h1> <h3 id="_12-1-基本情况"><a href="#_12-1-基本情况" class="header-anchor">#</a> 12.1 基本情况</h3> <p>上两节中的方案依然会存在技术缺陷，从而导致长连接断开（比如：长连接本身不可用（此时重连多少次也没用））。</p> <p>下面将优化和完善上述方案，从而保证 客户端与服务器依然保持着通信状态。</p> <p><strong>优化点主要是：</strong></p> <ul><li>1）确保当前网络的有效性和稳定性再开始长连接；</li> <li>2）自适应计算心跳包间隔时间的时机。</li></ul> <h3 id="_12-2-确保网络的有效性和稳定性后再开始长连接"><a href="#_12-2-确保网络的有效性和稳定性后再开始长连接" class="header-anchor">#</a> 12.2 确保网络的有效性和稳定性后再开始长连接</h3> <p><strong>问题描述：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ce6facaaf61e473dbe6b04d9d1f6fa9f~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>解决方案：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/745d913b6fd74bfb9ff9c93ed2070bfa~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>加入到原有的心跳保活机制主流程：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7a7aeee8c234713bbf41cc854749f7c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <h3 id="_12-3-自适应计算心跳包间隔时间的时机"><a href="#_12-3-自适应计算心跳包间隔时间的时机" class="header-anchor">#</a> 12.3 自适应计算心跳包间隔时间的时机</h3> <p><strong>问题描述：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc9cb9ce93f742048e657f47b6c391db~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>方案设计：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6943bf2c21ea4c37bb753ee1d98c2949~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>加入到到原有的心跳保活机制主流程：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/82ac850699134dd99290801195996c2b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <h3 id="_12-4-小结一下"><a href="#_12-4-小结一下" class="header-anchor">#</a> 12.4 小结一下</h3> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4bc4c9acaf3d40798f7b6601d3ca0270~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <h1 id="_13、额外思考-tcp协议自带的keepalive机制能否替代心跳机制"><a href="#_13、额外思考-tcp协议自带的keepalive机制能否替代心跳机制" class="header-anchor">#</a> 13、额外思考：TCP协议自带的KeepAlive机制能否替代心跳机制？</h1> <p>很多人认为，TCP 协议自身就有KeepAlive机制，为何基于它的通讯链接，仍需在应用层实现额外的心跳保活机制？</p> <ul><li>结论是：无法替代；</li> <li>原因是：TCP KeepAlive机制的作用是检测连接的有无（死活），但无法检测连接是否有效。</li></ul> <p><strong>注：</strong> “连接有效”的定义 = 双方具备发送 &amp; 接收消息的能力。</p> <p><strong>先来看看KeepAlive 机制是什么：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e96b75eb080c43d8a7d147c0a7ea959d~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>KeepAlive 的机制不可替代心跳机制的具体原因如下：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/318d82eb1f8143c58cdf80c7691703aa~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>特别注意：</strong></p> <ul><li>1）KeepAlive 机制只是操作系统底层的一个被动机制，不应该被上层应用层使用；</li> <li>2）当系统关闭一个由KeepAlive 机制检查出来的死连接时，是不会主动通知上层应用的，只能通过调用相应IO操作的返回值中发现。</li></ul> <p><strong>小结一下就是：</strong> KeepAlive机制无法代替心跳机制，需要在应用层 自己实现心跳机制以检测长连接的有效性，从而高效维持长连接。</p> <p><strong>Jack Jiang注：</strong> 关于TCP本身的KeepAlive机制，可能详读：</p> <ol><li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-281-1-1.html" title="http://www.52im.net/thread-281-1-1.html" target="_blank" rel="noopener noreferrer">为何基于TCP协议的移动端IM仍然需要心跳保活机制？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li> <li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3506-1-1.html" title="http://www.52im.net/thread-3506-1-1.html" target="_blank" rel="noopener noreferrer">彻底搞懂TCP协议层的KeepAlive保活机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</li></ol> <h1 id="_14、本文总结"><a href="#_14、本文总结" class="header-anchor">#</a> 14、本文总结</h1> <p>看完本文后，相信在高效维持长连接的需求下，你可以完美地解决了！</p> <p><strong>本文方案的主体设计就是：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b75691e5e3714a4db1b540459d87c6b1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <p><strong>方案的优化和完善内容就是：</strong></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/887809025bf847009adf420240da780f~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt=""></p> <h1 id="_15、参考资料"><a href="#_15、参考资料" class="header-anchor">#</a> 15、参考资料</h1> <p>[1] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Ftopic-tcpipvol1.html%253Fmobile%253Dno" title="http://www.52im.net/topic-tcpipvol1.html%3Fmobile%3Dno" target="_blank" rel="noopener noreferrer">TCP/IP详解 卷1：协议<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[2] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-281-1-1.html" title="http://www.52im.net/thread-281-1-1.html" target="_blank" rel="noopener noreferrer">为何基于TCP协议的移动端IM仍然需要心跳保活机制？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[3] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3506-1-1.html" title="http://www.52im.net/thread-3506-1-1.html" target="_blank" rel="noopener noreferrer">彻底搞懂TCP协议层的KeepAlive保活机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[4] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3713-1-1.html" title="http://www.52im.net/thread-3713-1-1.html" target="_blank" rel="noopener noreferrer">万字长文，一篇吃透WebSocket：概念、原理、易错常识、动手实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[5] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-120-1-1.html" title="http://www.52im.net/thread-120-1-1.html" target="_blank" rel="noopener noreferrer">移动端IM实践：实现Android版微信的智能心跳机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[6] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-121-1-1.html" title="http://www.52im.net/thread-121-1-1.html" target="_blank" rel="noopener noreferrer">移动端IM实践：WhatsApp、Line、微信的心跳策略分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[7] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-209-1-1.html" title="http://www.52im.net/thread-209-1-1.html" target="_blank" rel="noopener noreferrer">微信团队原创分享：Android版微信后台保活实战分享(网络保活篇)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[8] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2744-1-1.html" title="http://www.52im.net/thread-2744-1-1.html" target="_blank" rel="noopener noreferrer">融云技术分享：融云安卓端IM产品的网络链路保活技术实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[9] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3726-1-1.html" title="http://www.52im.net/thread-3726-1-1.html" target="_blank" rel="noopener noreferrer">阿里IM技术分享(五)：闲鱼亿级IM消息系统的及时性优化实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>[10] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2881-1-1.html" title="http://www.52im.net/thread-2881-1-1.html" target="_blank" rel="noopener noreferrer">2020年了，Android后台保活还有戏吗？看我如何优雅的实现！<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>（本文同步发布于：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3908-1-1.html" title="http://www.52im.net/thread-3908-1-1.html" target="_blank" rel="noopener noreferrer">www.52im.net/thread-3908…<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/23/2023, 8:50:24 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/knows/project/即时通讯/为什么不用TCP的keepalive设计心跳.html" class="prev">
        为什么不用TCP的keepalive设计心跳
      </a></span> <span class="next"><a href="/knows/project/即时通讯/搭建websocket消息推送服务必须要考虑的几个问题.html">
        搭建websocket消息推送服务必须要考虑的几个问题
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.282508ef.js" defer></script><script src="/assets/js/2.a1cbaef5.js" defer></script><script src="/assets/js/94.3262e5a7.js" defer></script>
  </body>
</html>
